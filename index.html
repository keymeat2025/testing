<!DOCTYPE html>
<html>
  <head>
    <title>Google Drive Folder & Image Browser</title>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .navigation {
        margin: 20px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      .breadcrumb {
        color: #666;
        margin-bottom: 10px;
      }
      .back-button {
        background-color: #666;
        margin-right: 10px;
      }
      .folder-grid, .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .folder-item {
        border: 2px solid #4285f4;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9ff;
      }
      .folder-item:hover {
        background-color: #e8f0fe;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .folder-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }
      .folder-name {
        font-weight: bold;
        word-break: break-word;
        margin-bottom: 5px;
      }
      .folder-count {
        color: #666;
        font-size: 12px;
      }
      .image-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        background-color: white;
      }
      .image-item img {
        max-width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
      }
      
      /* Modal styles for image gallery */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
      }
      
      .modal-content {
        position: relative;
        margin: auto;
        padding: 0;
        width: 90%;
        max-width: 1200px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-image {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
      }
      
      .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
      }
      
      .close:hover {
        color: #bbb;
      }
      
      .prev, .next {
        position: absolute;
        top: 50%;
        width: auto;
        padding: 16px;
        margin-top: -50px;
        color: white;
        font-weight: bold;
        font-size: 18px;
        background-color: rgba(0,0,0,0.5);
        border: none;
        cursor: pointer;
        user-select: none;
        z-index: 1001;
      }
      
      .next {
        right: 0;
        border-radius: 3px 0 0 3px;
      }
      
      .prev {
        left: 0;
        border-radius: 0 3px 3px 0;
      }
      
      .prev:hover, .next:hover {
        background-color: rgba(0,0,0,0.8);
      }
      
      .modal-info {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        background-color: rgba(0,0,0,0.7);
        padding: 10px 20px;
        border-radius: 5px;
      }
      
      .image-counter {
        font-size: 14px;
        margin-bottom: 5px;
      }
      
      .image-title {
        font-size: 16px;
        font-weight: bold;
      }
      
      /* Watermark styles */
      .watermarked {
        position: relative;
      }
      
      .watermarked::after {
        content: 'snapselect';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 12px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.3);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        pointer-events: none;
        z-index: 10;
        letter-spacing: 2px;
        text-transform: lowercase;
      }
      
      .watermarked img {
        filter: none; /* Remove the darkening effect */
      }
      
      /* Modal watermark */
      .modal-watermarked::after {
        content: 'snapselect';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 24px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.25);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        pointer-events: none;
        z-index: 1002;
        letter-spacing: 4px;
        text-transform: lowercase;
      }
      
      /* Random positioning classes */
      .watermarked.pos-1::after { top: 30%; left: 30%; }
      .watermarked.pos-2::after { top: 70%; left: 70%; }
      .watermarked.pos-3::after { top: 25%; left: 65%; }
      .watermarked.pos-4::after { top: 75%; left: 35%; }
      .watermarked.pos-5::after { top: 40%; left: 20%; }
      .watermarked.pos-6::after { top: 60%; left: 80%; }
      
      /* Random opacity classes */
      .watermarked.opacity-1::after { opacity: 0.2; }
      .watermarked.opacity-2::after { opacity: 0.3; }
      .watermarked.opacity-3::after { opacity: 0.25; }
      .watermarked.opacity-4::after { opacity: 0.35; }
      
      /* Slideshow styles */
      .slideshow-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: black;
        align-items: center;
        justify-content: center;
      }
      
      .slideshow-image {
        max-width: 90%;
        max-height: 85%;
        object-fit: contain;
        transition: opacity 0.3s ease;
      }
      
      .slideshow-controls {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        padding: 8px 15px;
        border-radius: 25px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .play-pause-btn {
        width: 35px;
        height: 35px;
        border: none;
        border-radius: 50%;
        background: #4285f4;
        color: white;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }
      
      .slideshow-info {
        color: white;
        font-size: 14px;
        margin: 0 10px;
        min-width: 80px;
        text-align: center;
      }
      
      .slideshow-close {
        width: 30px;
        height: 30px;
        border: none;
        border-radius: 50%;
        background: #666;
        color: white;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* Zoom modal styles */
      .zoom-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: black;
        align-items: center;
        justify-content: center;
      }
      
      .zoom-container {
        position: relative;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      
      .zoom-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.2s ease;
        cursor: grab;
      }
      
      .zoom-controls {
        position: absolute;
        bottom: 0;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(32, 33, 36, 0.9);
        padding: 8px 20px;
        border-radius: 24px 24px 0 0;
        display: flex;
        align-items: center;
        gap: 15px;
      }
      
      .zoom-btn {
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: rgba(255,255,255,0.1);
        color: white;
        cursor: pointer;
        font-size: 20px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
      }
      
      .zoom-btn:hover {
        background: rgba(255,255,255,0.2);
      }
      
      .zoom-indicator {
        color: white;
        font-size: 14px;
        min-width: 60px;
        text-align: center;
        font-family: 'Google Sans', Arial, sans-serif;
      }
      
      .zoom-close {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 40px;
        height: 40px;
        border: none;
        border-radius: 50%;
        background: rgba(32, 33, 36, 0.8);
        color: white;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
      }
      .image-name {
        margin-top: 10px;
        font-weight: bold;
        word-break: break-word;
        font-size: 14px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        background-color: #4285f4;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #3367d6;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .loading {
        text-align: center;
        margin: 20px;
        color: #666;
      }
      .empty-state {
        text-align: center;
        margin: 40px;
        color: #666;
      }
      .view-toggle {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>Google Drive Folder & Image Browser</h1>
    <p>Browse folders first, then view images inside them</p>

    <div class="view-toggle">
      <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
      <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
      <button id="load_folders_button" onclick="loadFolders()" disabled>Browse Folders</button>
      <button id="watermark_toggle" onclick="toggleWatermark()" disabled>üè∑Ô∏è Watermark: OFF</button>
      <button id="slideshow_button" onclick="startSlideshow()" disabled>üé¨ Slideshow</button>
      <button id="share_folders_button" onclick="openSimpleShareModal()" disabled style="background: linear-gradient(45deg, #34a853, #4285f4);">üì§ Share Folders</button>
    </div>

    <div id="navigation" class="navigation" style="display: none;">
      <div id="breadcrumb" class="breadcrumb"></div>
      <button id="back_button" class="back-button" onclick="goBack()" style="display: none;">‚Üê Back</button>
      <button onclick="loadFolders()">üìÅ Show Folders</button>
    </div>

    <div id="loading" class="loading" style="display: none;">Loading...</div>
    <div id="content-container"></div>

    <!-- Image Modal/Gallery -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <button class="prev" onclick="changeImage(-1)">&#10094;</button>
        <img id="modalImage" class="modal-image" src="" alt="">
        <button class="next" onclick="changeImage(1)">&#10095;</button>
        <div class="modal-info">
          <div id="imageCounter" class="image-counter"></div>
          <div id="imageTitle" class="image-title"></div>
        </div>
      </div>
    </div>

    <!-- Slideshow Modal -->
    <div id="slideshowModal" class="slideshow-modal">
      <img id="slideshowImage" class="slideshow-image" src="" alt="">
      <div class="slideshow-controls">
        <button id="playPauseBtn" class="play-pause-btn" onclick="toggleSlideshow()" title="Start slideshow">‚ñ∂Ô∏è</button>
        <div id="slideshowInfo" class="slideshow-info"></div>
        <button class="slideshow-close" onclick="closeSlideshow()" title="Close slideshow">‚úï</button>
      </div>
    </div>

    <!-- Zoom Modal -->
    <div id="zoomModal" class="zoom-modal">
      <div id="zoomContainer" class="zoom-container">
        <img id="zoomImage" class="zoom-image" src="" alt="">
        <div class="zoom-controls">
          <button class="zoom-btn" onclick="zoomOut()" title="Zoom out">‚àí</button>
          <div id="zoomIndicator" class="zoom-indicator">100%</div>
          <button class="zoom-btn" onclick="zoomIn()" title="Zoom in">+</button>
        </div>
        <button class="zoom-close" onclick="closeZoom()" title="Close">‚úï</button>
      </div>
    </div>

    <script type="text/javascript">
      const CLIENT_ID = '790992026707-a2ah00pav4gjq6u7m3au3amn9ij12hes.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyB0FkpFoTRWOXc8b6_gCzEKCoWMDcuA7NQ';
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;
      let currentFolderId = 'root';
      let folderHistory = [];
      let currentView = 'folders'; // 'folders' or 'images'
      let currentImages = []; // Store current folder's images for gallery
      let currentImageIndex = 0; // Current image in gallery
      let watermarkEnabled = false; // Watermark toggle state
      
      // Slideshow variables
      let slideshowInterval;
      let isPlaying = false;
      let slideshowIndex = 0;
      
      // Zoom variables
      let zoomScale = 1;
      let zoomTranslateX = 0;
      let zoomTranslateY = 0;
      let isDragging = false;
      let startX, startY;

      const IMAGE_MIME_TYPES = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif',
        'image/webp', 'image/bmp', 'image/svg+xml', 'image/tiff'
      ];

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '',
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('load_folders_button').disabled = false;
          document.getElementById('watermark_toggle').disabled = false;
          document.getElementById('slideshow_button').disabled = false;
          document.getElementById('share_folders_button').disabled = false;
          document.getElementById('authorize_button').innerText = 'Refresh';
          document.getElementById('navigation').style.display = 'block';
          
          // Initialize the folder ID fix system
          fixFolderIdCapture();
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content-container').innerHTML = '';
          document.getElementById('navigation').style.display = 'none';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
          document.getElementById('load_folders_button').disabled = true;
          document.getElementById('watermark_toggle').disabled = true;
          document.getElementById('slideshow_button').disabled = true;
          document.getElementById('share_folders_button').disabled = true;
          resetNavigation();
        }
      }

      function resetNavigation() {
        currentFolderId = 'root';
        folderHistory = [];
        currentView = 'folders';
        updateBreadcrumb();
      }

      function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        const backButton = document.getElementById('back_button');
        
        if (currentFolderId === 'root') {
          breadcrumb.textContent = `üìÅ Root Folder - Viewing: ${currentView}`;
          backButton.style.display = 'none';
        } else {
          breadcrumb.textContent = `üìÅ Current Folder - Viewing: ${currentView}`;
          backButton.style.display = 'inline-block';
        }
      }

      function goBack() {
        if (folderHistory.length > 0) {
          currentFolderId = folderHistory.pop();
          if (currentView === 'images') {
            loadImagesInFolder(currentFolderId);
          } else {
            loadFolders(currentFolderId);
          }
        }
      }

      async function loadFolders(folderId = 'root') {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content-container').innerHTML = '';
        currentView = 'folders';
        currentFolderId = folderId;
        updateBreadcrumb();

        try {
          const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            pageSize: 100,
            fields: 'files(id, name)',
            orderBy: 'name'
          });

          const folders = response.result.files || [];
          await displayFolders(folders);

        } catch (err) {
          console.error('Error loading folders:', err);
          document.getElementById('loading').textContent = 'Error loading folders: ' + err.message;
        }
      }

      async function displayFolders(folders) {
        const container = document.getElementById('content-container');
        document.getElementById('loading').style.display = 'none';

        if (folders.length === 0) {
          container.innerHTML = '<div class="empty-state">No folders found in this location.</div>';
          return;
        }

        const folderGrid = document.createElement('div');
        folderGrid.className = 'folder-grid';

        for (const folder of folders) {
          // Count images in this folder
          const imageCount = await countImagesInFolder(folder.id);
          
          const folderDiv = document.createElement('div');
          folderDiv.className = 'folder-item';
          folderDiv.onclick = () => openFolder(folder.id, folder.name);

          folderDiv.innerHTML = `
            <div class="folder-icon">üìÅ</div>
            <div class="folder-name">${folder.name}</div>
            <div class="folder-count">${imageCount} images</div>
          `;

          folderGrid.appendChild(folderDiv);
        }

        const summary = document.createElement('p');
        summary.textContent = `Found ${folders.length} folders`;
        summary.style.textAlign = 'center';
        summary.style.color = '#666';

        container.appendChild(summary);
        container.appendChild(folderGrid);
      }

      async function countImagesInFolder(folderId) {
        try {
          const mimeTypeQuery = IMAGE_MIME_TYPES.map(type => `mimeType='${type}'`).join(' or ');
          const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and (${mimeTypeQuery}) and trashed=false`,
            pageSize: 1000,
            fields: 'files(id)'
          });
          return response.result.files ? response.result.files.length : 0;
        } catch (err) {
          return 0;
        }
      }

      function openFolder(folderId, folderName) {
        folderHistory.push(currentFolderId);
        loadImagesInFolder(folderId);
      }

      async function loadImagesInFolder(folderId) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content-container').innerHTML = '';
        currentView = 'images';
        currentFolderId = folderId;
        updateBreadcrumb();

        try {
          const mimeTypeQuery = IMAGE_MIME_TYPES.map(type => `mimeType='${type}'`).join(' or ');
          
          const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and (${mimeTypeQuery}) and trashed=false`,
            pageSize: 100,
            fields: 'files(id, name, mimeType, thumbnailLink, webViewLink)',
            orderBy: 'name'
          });

          const images = response.result.files || [];
          currentImages = images; // Store for gallery navigation
          displayImages(images);

        } catch (err) {
          console.error('Error loading images:', err);
          document.getElementById('loading').textContent = 'Error loading images: ' + err.message;
        }
      }

      function displayImages(images) {
        const container = document.getElementById('content-container');
        document.getElementById('loading').style.display = 'none';

        if (images.length === 0) {
          container.innerHTML = '<div class="empty-state">No images found in this folder.</div>';
          return;
        }

        const imageGrid = document.createElement('div');
        imageGrid.className = 'image-grid';

        images.forEach((image, index) => {
          const imageDiv = document.createElement('div');
          imageDiv.className = 'image-item';
          
          // Add watermark class if enabled - this is ONLY for display, doesn't affect the actual file
          if (watermarkEnabled) {
            imageDiv.classList.add('watermarked');
            
            // Add random positioning and opacity for variety
            const randomPos = Math.floor(Math.random() * 6) + 1;
            const randomOpacity = Math.floor(Math.random() * 4) + 1;
            imageDiv.classList.add(`pos-${randomPos}`, `opacity-${randomOpacity}`);
          }

          const imgElement = document.createElement('img');
          
          // Use original image URLs - watermark is only CSS overlay for display
          if (image.thumbnailLink) {
            imgElement.src = image.thumbnailLink;
          } else {
            imgElement.src = `https://drive.google.com/thumbnail?id=${image.id}&sz=w300`;
          }
          
          imgElement.alt = image.name;
          imgElement.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+';
          };

          // Open gallery instead of Google Drive
          imgElement.onclick = function() {
            openImageGallery(index);
          };

          // Add double-click for zoom
          imgElement.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            openZoom(index);
          });

          const nameDiv = document.createElement('div');
          nameDiv.className = 'image-name';
          nameDiv.textContent = image.name;

          imageDiv.appendChild(imgElement);
          imageDiv.appendChild(nameDiv);
          imageGrid.appendChild(imageDiv);
        });

        const summary = document.createElement('p');
        summary.textContent = `Found ${images.length} images in this folder`;
        summary.style.textAlign = 'center';
        summary.style.color = '#666';

        container.appendChild(summary);
        container.appendChild(imageGrid);
      }

      // Gallery functions
      function openImageGallery(index) {
        currentImageIndex = index;
        const modal = document.getElementById('imageModal');
        updateModalImage();
        modal.style.display = 'block';
        
        // Add keyboard navigation
        document.addEventListener('keydown', handleKeyNavigation);
      }

      function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
        document.removeEventListener('keydown', handleKeyNavigation);
      }

      function changeImage(direction) {
        currentImageIndex += direction;
        
        // Wrap around
        if (currentImageIndex >= currentImages.length) {
          currentImageIndex = 0;
        } else if (currentImageIndex < 0) {
          currentImageIndex = currentImages.length - 1;
        }
        
        updateModalImage();
      }

      function updateModalImage() {
        if (currentImages.length === 0) return;
        
        const image = currentImages[currentImageIndex];
        const modalImage = document.getElementById('modalImage');
        const imageCounter = document.getElementById('imageCounter');
        const imageTitle = document.getElementById('imageTitle');
        const modalContent = document.querySelector('.modal-content');
        
        // Add/remove watermark class for modal
        if (watermarkEnabled) {
          modalContent.classList.add('modal-watermarked');
        } else {
          modalContent.classList.remove('modal-watermarked');
        }
        
        // Use higher resolution image for modal
        if (image.thumbnailLink) {
          // Try to get a larger thumbnail
          modalImage.src = image.thumbnailLink.replace(/=s\d+/, '=s800');
        } else {
          modalImage.src = `https://drive.google.com/thumbnail?id=${image.id}&sz=w800`;
        }
        
        // Update info
        imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        imageTitle.textContent = image.name;
        
        // Fallback to try direct image URL if thumbnail fails
        modalImage.onerror = function() {
          // Try the direct file view URL as a last resort
          this.src = `https://drive.google.com/uc?id=${image.id}`;
        };
      }

      function handleKeyNavigation(event) {
        switch(event.key) {
          case 'ArrowLeft':
            changeImage(-1);
            break;
          case 'ArrowRight':
            changeImage(1);
            break;
          case 'Escape':
            closeModal();
            break;
        }
      }

      // Close modal when clicking outside the image
      window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
          closeModal();
        }
      }

      // Watermark toggle function
      function toggleWatermark() {
        watermarkEnabled = !watermarkEnabled;
        const button = document.getElementById('watermark_toggle');
        
        if (watermarkEnabled) {
          button.textContent = 'üè∑Ô∏è Watermark: ON';
          button.style.backgroundColor = '#34a853';
        } else {
          button.textContent = 'üè∑Ô∏è Watermark: OFF';
          button.style.backgroundColor = '#4285f4';
        }
        
        // Update existing images without re-rendering - just toggle watermark classes
        if (currentView === 'images') {
          const imageItems = document.querySelectorAll('.image-item');
          
          imageItems.forEach((imageDiv, index) => {
            if (watermarkEnabled) {
              // Add watermark classes
              imageDiv.classList.add('watermarked');
              
              // Remove any existing position/opacity classes first
              imageDiv.classList.remove('pos-1', 'pos-2', 'pos-3', 'pos-4', 'pos-5', 'pos-6');
              imageDiv.classList.remove('opacity-1', 'opacity-2', 'opacity-3', 'opacity-4');
              
              // Add random positioning and opacity for variety
              const randomPos = Math.floor(Math.random() * 6) + 1;
              const randomOpacity = Math.floor(Math.random() * 4) + 1;
              imageDiv.classList.add(`pos-${randomPos}`, `opacity-${randomOpacity}`);
            } else {
              // Remove watermark classes
              imageDiv.classList.remove('watermarked');
              imageDiv.classList.remove('pos-1', 'pos-2', 'pos-3', 'pos-4', 'pos-5', 'pos-6');
              imageDiv.classList.remove('opacity-1', 'opacity-2', 'opacity-3', 'opacity-4');
            }
          });
          
          // Also update modal if it's open
          const modalContent = document.querySelector('.modal-content');
          if (modalContent) {
            if (watermarkEnabled) {
              modalContent.classList.add('modal-watermarked');
            } else {
              modalContent.classList.remove('modal-watermarked');
            }
          }
        }
      }

      // FOLDER ID FIX SYSTEM - Integrated from paste.txt
      function fixFolderIdCapture() {
        console.log('üîß Fixing folder ID capture to get real Google Drive IDs...');
        
        // First, let's see what's happening with folder loading
        const originalDisplayFolders = window.displayFolders;
        
        window.displayFolders = async function(folders) {
          console.log('üìÅ Original folders data from Google Drive API:', folders);
          
          // Call original function first
          await originalDisplayFolders(folders);
          
          // Now capture the REAL folder IDs and store them
          const folderElements = document.querySelectorAll('.folder-item');
          console.log('üéØ Found folder elements:', folderElements.length);
          
          // Create a mapping of real folder data
          window.realFolderData = folders.map((folder, index) => {
            const element = folderElements[index];
            const nameEl = element?.querySelector('.folder-name');
            const countEl = element?.querySelector('.folder-count');
            
            return {
              realId: folder.id, // This is the REAL Google Drive folder ID
              name: folder.name,
              displayName: nameEl?.textContent || folder.name,
              imageCount: countEl?.textContent || '0 images',
              element: element
            };
          });
          
          console.log('‚úÖ Real folder data captured:', window.realFolderData);
          
          // Verify the real IDs look correct
          window.realFolderData.forEach((folder, index) => {
            console.log(`üìÅ ${index}: "${folder.name}" -> Real ID: ${folder.realId}`);
            
            if (folder.realId.length < 20) {
              console.warn(`‚ö†Ô∏è Suspicious short ID for ${folder.name}: ${folder.realId}`);
            }
          });
        };
        
        console.log('‚úÖ Folder ID capture system fixed!');
      }

      // Share modal with REAL folder IDs
      window.openSimpleShareModal = function() {
        console.log('üì§ Opening FIXED share modal with real folder IDs...');
        
        // Check if we have real folder data
        if (!window.realFolderData || window.realFolderData.length === 0) {
          alert('‚ùå No real folder data found!\n\nPlease:\n1. Click "Browse Folders"\n2. Wait for folders to load\n3. Then try Share again');
          return;
        }
        
        const folders = window.realFolderData;
        console.log('üìã Using real folder data:', folders);
        
        // Remove existing modal
        const existingModal = document.getElementById('fixedShareModal');
        if (existingModal) {
          document.body.removeChild(existingModal);
        }
        
        // Create modal with real folder IDs
        const modal = document.createElement('div');
        modal.id = 'fixedShareModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
          background: rgba(0,0,0,0.85); z-index: 9999; display: flex;
          align-items: center; justify-content: center; backdrop-filter: blur(2px);
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white; padding: 35px; border-radius: 16px; width: 550px;
          max-height: 85vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        `;
        
        dialog.innerHTML = `
          <div style="text-align: center; margin-bottom: 25px;">
            <h2 style="margin: 0; color: #333; font-size: 24px;">üì§ Share Folders (FIXED)</h2>
            <p style="margin: 10px 0 0 0; color: #666;">Using REAL Google Drive folder IDs</p>
          </div>
          
          <div style="margin: 25px 0;">
            <div style="display: flex; gap: 10px; margin-bottom: 15px;">
              <button id="selectAllFixed" style="padding: 10px 16px; background: #4285f4; color: white; border: none; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 500;">‚úì Select All</button>
              <button id="deselectAllFixed" style="padding: 10px 16px; background: #666; color: white; border: none; border-radius: 6px; cursor: pointer; flex: 1; font-weight: 500;">‚úó Deselect All</button>
            </div>
            
            <div id="fixedFolderList" style="max-height: 280px; overflow-y: auto; border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; background: #f9f9f9;">
              ${folders.map((folder, index) => `
                <div style="display: flex; align-items: center; padding: 15px; margin: 8px 0; border-radius: 8px; background: white; border: 1px solid #e0e0e0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <input type="checkbox" id="fixedFolder_${index}" value="${index}" 
                         style="margin-right: 15px; transform: scale(1.4); accent-color: #4285f4;">
                  <label for="fixedFolder_${index}" style="flex: 1; cursor: pointer; display: flex; flex-direction: column; gap: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <span style="font-weight: 600; color: #333; font-size: 16px;">üìÅ ${folder.name}</span>
                      <span style="color: #888; font-size: 12px; background: #e8f0fe; padding: 4px 10px; border-radius: 12px; font-weight: 500;">${folder.imageCount}</span>
                    </div>
                    <div style="font-size: 11px; color: #666; font-family: monospace;">ID: ${folder.realId}</div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div style="margin: 25px 0;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333; font-size: 16px;">üîë Password for Client Access:</label>
            <input type="password" id="fixedPassword" placeholder="Enter password (e.g., wedding2024)" 
                   style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; font-family: monospace;">
          </div>
          
          <div style="margin: 25px 0;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333; font-size: 16px;">üîó Generated Share Links (REAL IDs):</label>
            <textarea id="fixedShareLinks" readonly rows="6" placeholder="Real Google Drive folder IDs will be used..."
                     style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; background: #f8f8f8; box-sizing: border-box; resize: vertical; font-family: monospace; font-size: 13px; line-height: 1.4;"></textarea>
          </div>
          
          <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px;">
            <button id="cancelFixed" style="padding: 15px 25px; border: 2px solid #ccc; background: white; color: #666; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">Cancel</button>
            <button id="generateFixed" style="padding: 15px 25px; border: none; background: linear-gradient(45deg, #34a853, #4285f4); color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">Generate REAL Links</button>
            <button id="copyFixed" style="padding: 15px 25px; border: none; background: #34a853; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üìã Copy All</button>
          </div>
          
          <div style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #4caf50;">
            <div style="font-weight: bold; color: #2e7d32; margin-bottom: 5px;">‚úÖ FIXED: Now using REAL Google Drive folder IDs!</div>
            <div style="color: #388e3c; font-size: 14px;">Share links will now load actual images from Google Drive</div>
          </div>
        `;
        
        modal.appendChild(dialog);
        document.body.appendChild(modal);
        
        // Event listeners
        document.getElementById('selectAllFixed').onclick = () => {
          document.querySelectorAll('#fixedFolderList input[type="checkbox"]').forEach(cb => cb.checked = true);
        };
        
        document.getElementById('deselectAllFixed').onclick = () => {
          document.querySelectorAll('#fixedFolderList input[type="checkbox"]').forEach(cb => cb.checked = false);
        };
        
        document.getElementById('cancelFixed').onclick = () => {
          document.body.removeChild(modal);
        };
        
        document.getElementById('generateFixed').onclick = () => {
          const password = document.getElementById('fixedPassword').value.trim();
          if (!password) {
            alert('üîë Please enter a password first!');
            document.getElementById('fixedPassword').focus();
            return;
          }
          
          const selectedCheckboxes = document.querySelectorAll('#fixedFolderList input[type="checkbox"]:checked');
          if (selectedCheckboxes.length === 0) {
            alert('üìÅ Please select at least one folder!');
            return;
          }
          
          const shareLinks = [];
          selectedCheckboxes.forEach(checkbox => {
            const folderIndex = parseInt(checkbox.value);
            const folder = folders[folderIndex];
            
            // Create share data with REAL Google Drive folder ID
            const shareData = {
              folderId: folder.realId, // ‚úÖ REAL Google Drive folder ID
              folderName: folder.name,
              password: btoa(password),
              timestamp: Date.now(),
              imageCount: folder.imageCount
            };
            
            const encodedData = btoa(JSON.stringify(shareData));
            const shareUrl = `https://keymeat2025.github.io/testing/client-gallery.html?share=${encodedData}`;
            
            shareLinks.push(`üìÅ Folder: ${folder.name}\nüîó Link: ${shareUrl}\nüîë Password: ${password}\nüìä Images: ${folder.imageCount}\nüÜî Real ID: ${folder.realId}`);
          });
          
          const linksText = shareLinks.join('\n\n' + '='.repeat(70) + '\n\n');
          document.getElementById('fixedShareLinks').value = linksText;
          
          alert(`üéâ SUCCESS!\n\nGenerated ${selectedCheckboxes.length} share links with REAL Google Drive folder IDs!\n\nPassword: "${password}"\n\nThese links will now load actual images from Google Drive!`);
          
          console.log('‚úÖ Generated REAL share links:', shareLinks.length);
        };
        
        document.getElementById('copyFixed').onclick = () => {
          const textarea = document.getElementById('fixedShareLinks');
          if (!textarea.value.trim()) {
            alert('üìù Please generate links first!');
            return;
          }
          
          textarea.select();
          document.execCommand('copy');
          alert(`üìã Copied ${document.querySelectorAll('#fixedFolderList input[type="checkbox"]:checked').length} REAL share links!\n\n‚ú® These will work with actual Google Drive images!`);
        };
        
        // Close on outside click
        modal.onclick = (e) => {
          if (e.target === modal) {
            document.body.removeChild(modal);
          }
        };
        
        console.log('‚úÖ FIXED modal opened with real folder IDs');
      };
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
