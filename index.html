<!DOCTYPE html>
<html>
  <head>
    <title>Google Drive Image Browser</title>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-top: 20px;
      }
      .image-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
      }
      .image-item img {
        max-width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 4px;
      }
      .image-name {
        margin-top: 10px;
        font-weight: bold;
        word-break: break-word;
      }
      .folder-path {
        color: #666;
        font-size: 12px;
        margin-top: 5px;
      }
      button {
        padding: 10px 20px;
        margin: 10px;
        border: none;
        border-radius: 4px;
        background-color: #4285f4;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #3367d6;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .loading {
        text-align: center;
        margin: 20px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>Google Drive Image Browser</h1>
    <p>Browse and view image files from your Google Drive folders</p>

    <!--Add buttons to initiate auth sequence and sign out-->
    <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
    <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
    <button id="load_images_button" onclick="loadAllImages()" disabled>Load Images</button>

    <div id="loading" class="loading" style="display: none;">Loading images...</div>
    <div id="image-container" class="image-grid"></div>

    <script type="text/javascript">
      // TODO(developer): Set to client ID and API key from the Developer Console
      const CLIENT_ID = '790992026707-a2ah00pav4gjq6u7m3au3amn9ij12hes.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyB0FkpFoTRWOXc8b6_gCzEKCoWMDcuA7NQ';

      // Discovery doc URL for APIs used by the quickstart
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';

      // Authorization scopes - need readonly access for files
      const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      // Image MIME types to filter for
      const IMAGE_MIME_TYPES = [
        'image/jpeg',
        'image/jpg', 
        'image/png',
        'image/gif',
        'image/webp',
        'image/bmp',
        'image/svg+xml',
        'image/tiff'
      ];

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

      /**
       * Callback after api.js is loaded.
       */
      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      /**
       * Callback after the API client is loaded. Loads the
       * discovery doc to initialize the API.
       */
      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      /**
       * Callback after Google Identity Services are loaded.
       */
      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '', // defined later
        });
        gisInited = true;
        maybeEnableButtons();
      }

      /**
       * Enables user interaction after all libraries are loaded.
       */
      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      /**
       *  Sign in the user upon button click.
       */
      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('load_images_button').disabled = false;
          document.getElementById('authorize_button').innerText = 'Refresh';
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      /**
       *  Sign out the user upon button click.
       */
      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('image-container').innerHTML = '';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
          document.getElementById('load_images_button').disabled = true;
        }
      }

      /**
       * Get folder name by folder ID
       */
      async function getFolderName(folderId) {
        try {
          const response = await gapi.client.drive.files.get({
            fileId: folderId,
            fields: 'name'
          });
          return response.result.name;
        } catch (err) {
          return 'Unknown Folder';
        }
      }

      /**
       * Load all image files from Google Drive
       */
      async function loadAllImages() {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('image-container').innerHTML = '';
        
        let allImages = [];
        let nextPageToken = null;

        try {
          do {
            // Create query to find only image files
            const mimeTypeQuery = IMAGE_MIME_TYPES.map(type => `mimeType='${type}'`).join(' or ');
            
            const response = await gapi.client.drive.files.list({
              pageSize: 100,
              fields: 'nextPageToken, files(id, name, mimeType, parents, thumbnailLink, webViewLink)',
              q: `(${mimeTypeQuery}) and trashed=false`,
              pageToken: nextPageToken
            });

            if (response.result.files && response.result.files.length > 0) {
              allImages = allImages.concat(response.result.files);
            }

            nextPageToken = response.result.nextPageToken;
          } while (nextPageToken);

          await displayImages(allImages);

        } catch (err) {
          console.error('Error loading images:', err);
          document.getElementById('loading').textContent = 'Error loading images: ' + err.message;
        }
      }

      /**
       * Display images in the grid
       */
      async function displayImages(images) {
        const container = document.getElementById('image-container');
        document.getElementById('loading').style.display = 'none';

        if (!images || images.length === 0) {
          container.innerHTML = '<p>No image files found in your Google Drive.</p>';
          return;
        }

        // Get folder names for images that have parents
        const folderCache = {};
        
        for (const image of images) {
          const imageDiv = document.createElement('div');
          imageDiv.className = 'image-item';

          // Get folder path
          let folderPath = 'Root';
          if (image.parents && image.parents.length > 0) {
            const folderId = image.parents[0];
            if (!folderCache[folderId]) {
              folderCache[folderId] = await getFolderName(folderId);
            }
            folderPath = folderCache[folderId];
          }

          // Create image element
          const imgElement = document.createElement('img');
          
          // Use thumbnail if available, otherwise try to construct a thumbnail URL
          if (image.thumbnailLink) {
            imgElement.src = image.thumbnailLink;
          } else {
            // Fallback: construct thumbnail URL
            imgElement.src = `https://drive.google.com/thumbnail?id=${image.id}&sz=w300`;
          }
          
          imgElement.alt = image.name;
          imgElement.onerror = function() {
            // If thumbnail fails, show a placeholder
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+';
          };

          // Make image clickable to open in Google Drive
          imgElement.style.cursor = 'pointer';
          imgElement.onclick = function() {
            window.open(image.webViewLink, '_blank');
          };

          const nameDiv = document.createElement('div');
          nameDiv.className = 'image-name';
          nameDiv.textContent = image.name;

          const folderDiv = document.createElement('div');
          folderDiv.className = 'folder-path';
          folderDiv.textContent = `Folder: ${folderPath}`;

          imageDiv.appendChild(imgElement);
          imageDiv.appendChild(nameDiv);
          imageDiv.appendChild(folderDiv);

          container.appendChild(imageDiv);
        }

        // Add summary
        const summary = document.createElement('p');
        summary.textContent = `Found ${images.length} image files`;
        summary.style.textAlign = 'center';
        summary.style.marginTop = '20px';
        summary.style.color = '#666';
        container.insertBefore(summary, container.firstChild);
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
