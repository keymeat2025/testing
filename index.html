
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Photo Gallery Creator</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 20px;
        }

        .step-title {
            font-size: 1.8rem;
            color: #333;
            font-weight: 300;
        }

        .step-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
            margin-bottom: 30px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 133, 244, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #4285f4;
            border: 2px solid #4285f4;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4285f4;
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4285f4, #34a853);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .guided-setup {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }

        .setup-step {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #4285f4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .setup-step.completed {
            border-left-color: #34a853;
            background: #f8fff8;
        }

        .setup-step h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .step-number-small {
            background: #4285f4;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }

        .step-number-small.completed {
            background: #34a853;
        }

        .quick-link {
            display: inline-block;
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: bold;
            margin: 10px 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3);
        }

        .quick-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
            color: white;
            text-decoration: none;
        }

        .copy-section {
            background: #e9ecef;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px dashed #6c757d;
        }

        .copy-section label {
            font-weight: bold;
            display: block;
            margin-bottom: 8px;
            color: #495057;
        }

        .copy-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-family: monospace;
            background: white;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 8px;
            font-size: 0.9rem;
        }

        .copy-btn:hover {
            background: #218838;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .validation-status {
            margin-top: 10px;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .validation-status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .validation-status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .validation-status.loading {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #99d6ff;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .file-upload-area {
            border: 3px dashed #4285f4;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 20px 0;
        }

        .file-upload-area:hover {
            background: #e9ecef;
            border-color: #34a853;
        }

        .file-upload-area.dragover {
            background: #e8f5e8;
            border-color: #34a853;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #4285f4;
        }

        .file-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-remove:hover {
            background: #c82333;
        }

        .upload-progress {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            display: none;
            border: 2px solid #e0e0e0;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-item {
            margin-bottom: 20px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .progress-bar-small {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill-small {
            height: 100%;
            background: linear-gradient(90deg, #4285f4, #34a853);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        .gallery-result {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e8f5e8;
        }

        .gallery-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .share-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .copy-link-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .link-display {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-link-btn {
            padding: 12px 20px;
            background: #34a853;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }

        .copy-link-btn:hover {
            background: #2d8f47;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #99d6ff;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #4285f4;
            font-size: 1rem;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(66, 133, 244, 0.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .copy-link-container {
                flex-direction: column;
            }
            
            .link-display {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì∏ Google Drive Gallery Creator</h1>
            <p>Create and share photo galleries directly in Google Drive</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Step 1: Setup Introduction -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Quick Setup Required</div>
                </div>
                <div class="step-content">
                    <p>To create unlimited photo galleries in your Google Drive, we need to set up a free Google Cloud project. This takes about 5 minutes and gives you complete control.</p>
                    
                    <div class="alert alert-info">
                        <strong>üéØ What You'll Get:</strong><br>
                        ‚Ä¢ Unlimited photo galleries in your Google Drive<br>
                        ‚Ä¢ Complete privacy - everything stays in your account<br>
                        ‚Ä¢ Free Google Drive API quota (up to 1 billion requests/day)<br>
                        ‚Ä¢ Full control over sharing and permissions
                    </div>

                    <div class="guided-setup">
                        <h3>üìã Setup Overview</h3>
                        <p>We'll guide you through each step with direct links and exact instructions. You'll need:</p>
                        <ul style="margin: 15px 0; padding-left: 30px; color: #555;">
                            <li>A Google account (free)</li>
                            <li>5 minutes of your time</li>
                            <li>No credit card required</li>
                        </ul>
                        
                        <div style="text-align: center; margin: 25px 0;">
                            <button class="btn btn-primary" onclick="startSetup()">
                                üöÄ Start 5-Minute Setup
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Guided Setup -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Follow the Setup Steps</div>
                </div>
                <div class="step-content">
                    <p>Follow these steps exactly as shown. We'll guide you through each one with direct links.</p>
                    
                    <div class="setup-step" id="setupStep1">
                        <h4>
                            <div class="step-number-small">1</div>
                            Create Google Cloud Project
                        </h4>
                        <p>First, create a new Google Cloud project (completely free!).</p>
                        
                        <a href="https://console.cloud.google.com/projectcreate" target="_blank" class="quick-link">
                            üèóÔ∏è Create New Project
                        </a>
                        
                        <div class="copy-section">
                            <label>Project Name (copy and paste this):</label>
                            <input type="text" class="copy-input" value="Photo Gallery Creator" readonly>
                            <button class="copy-btn" onclick="copyToClipboard('Photo Gallery Creator')">üìã Copy</button>
                        </div>
                        
                        <p><strong>Instructions:</strong></p>
                        <ol style="margin: 10px 0; padding-left: 25px;">
                            <li>Click the blue "Create New Project" button above</li>
                            <li>Paste "Photo Gallery Creator" as the project name</li>
                            <li>Click "Create"</li>
                            <li>Wait for the project to be created (30 seconds)</li>
                        </ol>
                        
                        <button class="btn btn-secondary" onclick="markStepComplete(1)">
                            ‚úÖ Step 1 Complete
                        </button>
                    </div>

                    <div class="setup-step" id="setupStep2">
                        <h4>
                            <div class="step-number-small">2</div>
                            Enable Google Drive API
                        </h4>
                        <p>Enable the Google Drive API for your new project.</p>
                        
                        <a href="https://console.cloud.google.com/apis/library/drive.googleapis.com" target="_blank" class="quick-link">
                            üîå Enable Drive API
                        </a>
                        
                        <p><strong>Instructions:</strong></p>
                        <ol style="margin: 10px 0; padding-left: 25px;">
                            <li>Click the "Enable Drive API" button above</li>
                            <li>Make sure your "Photo Gallery Creator" project is selected (top of page)</li>
                            <li>Click the blue "Enable" button</li>
                            <li>Wait for activation (15 seconds)</li>
                        </ol>
                        
                        <button class="btn btn-secondary" onclick="markStepComplete(2)">
                            ‚úÖ Step 2 Complete
                        </button>
                    </div>

                    <div class="setup-step" id="setupStep3">
                        <h4>
                            <div class="step-number-small">3</div>
                            Create API Credentials
                        </h4>
                        <p>Create OAuth2 credentials so the app can access your Google Drive.</p>
                        
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="quick-link">
                            üîë Create Credentials
                        </a>
                        
                        <p><strong>Instructions:</strong></p>
                        <ol style="margin: 10px 0; padding-left: 25px;">
                            <li>Click "Create Credentials" ‚Üí "OAuth client ID"</li>
                            <li>If prompted, configure OAuth consent screen first (choose "External", fill required fields)</li>
                            <li>Choose "Web application" as application type</li>
                            <li>Name it "Gallery Creator Web App"</li>
                            <li>Add this URL to "Authorized JavaScript origins":</li>
                        </ol>
                        
                        <div class="copy-section">
                            <label>Authorized JavaScript Origins:</label>
                            <input type="text" class="copy-input" id="currentOrigin" readonly>
                            <button class="copy-btn" onclick="copyCurrentOrigin()">üìã Copy</button>
                        </div>
                        
                        <button class="btn btn-secondary" onclick="markStepComplete(3)">
                            ‚úÖ Step 3 Complete
                        </button>
                    </div>

                    <div class="setup-step" id="setupStep4">
                        <h4>
                            <div class="step-number-small">4</div>
                            Copy Your Credentials
                        </h4>
                        <p>Copy the Client ID and API Key from Google Cloud Console.</p>
                        
                        <div class="form-group">
                            <label for="clientIdInput">üîë Client ID:</label>
                            <input type="text" id="clientIdInput" class="form-input" placeholder="123456789-abcdefghijk.apps.googleusercontent.com" oninput="validateInputs()">
                            <small>From the OAuth2 client you just created</small>
                        </div>

                        <div class="form-group">
                            <label for="apiKeyInput">üóùÔ∏è API Key:</label>
                            <input type="text" id="apiKeyInput" class="form-input" placeholder="AIzaSyABC123DEF456GHI789JKL012MNO345PQR" oninput="validateInputs()">
                            <small>Create this in "Credentials" ‚Üí "Create credentials" ‚Üí "API key"</small>
                        </div>

                        <button class="btn btn-primary" onclick="testCredentials()" id="testBtn" disabled>
                            üîç Test Connection
                        </button>
                        
                        <div id="validationResult"></div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="prevStep()">
                        ‚Üê Back
                    </button>
                    <button class="btn btn-primary" onclick="nextStep()" id="setupCompleteBtn" disabled>
                        Setup Complete! ‚Üí
                    </button>
                </div>
            </div>

            <!-- Step 3: Create Gallery -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Create Your Gallery</div>
                </div>
                <div class="step-content">
                    <div class="alert alert-success">
                        <strong>üéâ Setup Complete!</strong> Your Google Drive connection is ready. Now let's create your first photo gallery!
                    </div>
                    
                    <div class="guided-setup">
                        <div class="form-group">
                            <label for="galleryName">üìù Gallery Name</label>
                            <input type="text" id="galleryName" class="form-input" placeholder="e.g., Family Vacation 2024, Wedding Photos..." oninput="updateCreateButton()">
                        </div>

                        <div class="form-group">
                            <label>üì∑ Upload Photos</label>
                            <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                                <div class="upload-icon">üìÅ</div>
                                <h3>Drop photos here or click to browse</h3>
                                <p>Support: JPG, PNG, GIF, WEBP (Max 100MB each)</p>
                            </div>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                            
                            <div class="file-list" id="fileList"></div>
                        </div>

                        <div class="upload-progress" id="uploadProgress">
                            <h4>üì§ Creating Gallery...</h4>
                            <div id="progressList"></div>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="createGallery()" id="createBtn" disabled>
                        üé® Create Gallery
                    </button>
                    <button class="btn btn-secondary" onclick="resetGalleryForm()">
                        üîÑ Reset Form
                    </button>
                </div>
            </div>

            <!-- Step 4: Gallery Created -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">üéâ</div>
                    <div class="step-title">Gallery Created!</div>
                </div>
                <div class="step-content">
                    <div class="gallery-result">
                        <div class="gallery-header">
                            <h3 id="createdGalleryTitle">üì∏ Your Photo Gallery</h3>
                        </div>

                        <div class="share-section">
                            <label><strong>üîó Shareable Link:</strong></label>
                            <p style="margin: 10px 0; color: #666;">Share this link with anyone to let them view your photos</p>
                            <div class="copy-link-container">
                                <input type="text" id="shareableLink" readonly class="link-display">
                                <button onclick="copyShareLink()" class="copy-link-btn">
                                    üìã Copy Link
                                </button>
                            </div>
                        </div>

                        <div class="share-section">
                            <label><strong>üìÅ Google Drive Folder:</strong></label>
                            <p style="margin: 10px 0; color: #666;">Manage your photos directly in Google Drive</p>
                            <div class="copy-link-container">
                                <input type="text" id="driveLink" readonly class="link-display">
                                <button onclick="openDriveFolder()" class="copy-link-btn">
                                    üöÄ Open Drive
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <strong>‚úÖ Success!</strong> Your gallery has been created in Google Drive and is ready to share!
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="createNewGallery()">
                        ‚ûï Create Another Gallery
                    </button>
                    <button class="btn btn-secondary" onclick="openDriveFolder()">
                        üìÅ View in Google Drive
                    </button>
                </div>
            </div>

            <div class="navigation">
                <button class="nav-btn" id="prevBtn" onclick="prevStep()" disabled>
                    ‚Üê Previous
                </button>
                <span id="stepIndicator">Step 1 of 4</span>
                <button class="nav-btn" id="nextBtn" onclick="nextStep()" style="display: none;">
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let clientId = '';
        let apiKey = '';
        let gapi;
        let isAuthenticated = false;
        let selectedFiles = [];
        let createdFolderId = '';
        let completedSteps = [];

        // Initialize Google API when script loads
        function initGoogleAPI() {
            console.log('Google API script loaded successfully');
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressBar();
            setupFileHandling();
            
            // Set current origin for OAuth setup
            const currentOriginInput = document.getElementById('currentOrigin');
            if (currentOriginInput) {
                currentOriginInput.value = window.location.origin;
            }
            
            // Check if Google API is available
            setTimeout(() => {
                if (typeof gapi === 'undefined') {
                    showAlert('‚ö†Ô∏è Google API failed to load. Please check your internet connection and reload the page.', 'error');
                }
            }, 3000);
        });

        function startSetup() {
            nextStep();
        }




        function markStepComplete(stepNum) {
                    if (!completedSteps.includes(stepNum)) {
                        completedSteps.push(stepNum);
                    }
                    
                    const stepElement = document.getElementById(`setupStep${stepNum}`);
                    if (stepElement) {
                        stepElement.classList.add('completed');
                        
                        const stepNumber = stepElement.querySelector('.step-number-small');
                        if (stepNumber) {
                            stepNumber.classList.add('completed');
                            stepNumber.textContent = '‚úì';
                        }
                    }
                    
                    // Check if we can enable the test button
                    if (completedSteps.length >= 3) {
                        const clientIdInput = document.getElementById('clientIdInput');
                        if (clientIdInput) {
                            clientIdInput.focus();
                        }
                    }
                }
        
                function copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(() => {
                        showAlert('Copied to clipboard! üìã', 'success');
                    }).catch(() => {
                        // Fallback for older browsers
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showAlert('Copied to clipboard! üìã', 'success');
                    });
                }
        
                function copyCurrentOrigin() {
                    const origin = window.location.origin;
                    copyToClipboard(origin);
                }
        
                function validateInputs() {
                    const clientIdInput = document.getElementById('clientIdInput');
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    const testBtn = document.getElementById('testBtn');
                    
                    if (!clientIdInput || !apiKeyInput || !testBtn) return;
                    
                    const clientIdValue = clientIdInput.value.trim();
                    const apiKeyValue = apiKeyInput.value.trim();
                    
                    // Basic validation
                    const isClientIdValid = clientIdValue.includes('.apps.googleusercontent.com');
                    const isApiKeyValid = apiKeyValue.startsWith('AIza') && apiKeyValue.length > 30;
                    
                    testBtn.disabled = !(isClientIdValid && isApiKeyValid);
                }
        
                async function testCredentials() {
                    const clientIdInput = document.getElementById('clientIdInput');
                    const apiKeyInput = document.getElementById('apiKeyInput');
                    const resultDiv = document.getElementById('validationResult');
                    const setupCompleteBtn = document.getElementById('setupCompleteBtn');
                    
                    if (!clientIdInput || !apiKeyInput) return;
                    
                    const clientIdValue = clientIdInput.value.trim();
                    const apiKeyValue = apiKeyInput.value.trim();
                    
                    // Check if Google API is loaded
                    if (typeof gapi === 'undefined') {
                        if (resultDiv) {
                            resultDiv.innerHTML = `
                                <div class="validation-status error">
                                    ‚ùå Google API not loaded. Please reload the page and try again.
                                </div>
                            `;
                        }
                        return;
                    }
                    
                    // Show loading state
                    if (resultDiv) {
                        resultDiv.innerHTML = `
                            <div class="validation-status loading">
                                <div class="spinner"></div>
                                Testing connection to Google Drive...
                            </div>
                        `;
                    }
                    
                    try {
                        // Store credentials
                        clientId = clientIdValue;
                        apiKey = apiKeyValue;
                        
                        // Initialize Google API
                        await initializeGoogleAPI();
                        
                        // Test authentication
                        await testGoogleConnection();
                        
                        if (resultDiv) {
                            resultDiv.innerHTML = `
                                <div class="validation-status success">
                                    ‚úÖ Connection successful! Your credentials are working perfectly.
                                </div>
                            `;
                        }
                        
                        if (setupCompleteBtn) {
                            setupCompleteBtn.disabled = false;
                        }
                        
                    } catch (error) {
                        console.error('Credential test failed:', error);
                        if (resultDiv) {
                            resultDiv.innerHTML = `
                                <div class="validation-status error">
                                    ‚ùå Connection failed: ${error.message || 'Please check your credentials and try again.'}
                                </div>
                            `;
                        }
                        if (setupCompleteBtn) {
                            setupCompleteBtn.disabled = true;
                        }
                    }
                }
        
                async function initializeGoogleAPI() {
                    return new Promise((resolve, reject) => {
                        // Double check that gapi is available
                        if (typeof gapi === 'undefined') {
                            reject(new Error('Google API script not loaded. Please reload the page.'));
                            return;
                        }
                        
                        // Wait a bit more for gapi to be fully ready
                        const initGapi = () => {
                            try {
                                gapi.load('auth2:client', async () => {
                                    try {
                                        await gapi.client.init({
                                            apiKey: apiKey,
                                            clientId: clientId,
                                            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                                            scope: 'https://www.googleapis.com/auth/drive.file'
                                        });
                                        resolve();
                                    } catch (error) {
                                        reject(new Error(`Failed to initialize Google client: ${error.message}`));
                                    }
                                });
                            } catch (error) {
                                reject(new Error(`Failed to load Google API modules: ${error.message}`));
                            }
                        };
                        
                        // If gapi.load is not ready, wait a bit
                        if (typeof gapi.load === 'undefined') {
                            setTimeout(initGapi, 1000);
                        } else {
                            initGapi();
                        }
                    });
                }
        
                async function testGoogleConnection() {
                    const authInstance = gapi.auth2.getAuthInstance();
                    
                    if (!authInstance.isSignedIn.get()) {
                        await authInstance.signIn();
                    }
                    
                    // Test API call
                    const response = await gapi.client.drive.about.get({
                        fields: 'user'
                    });
                    
                    if (response.status === 200) {
                        isAuthenticated = true;
                        return response.result;
                    } else {
                        throw new Error('Failed to connect to Google Drive');
                    }
                }
        
                // File handling functions
                function setupFileHandling() {
                    const fileInput = document.getElementById('fileInput');
                    const uploadArea = document.getElementById('uploadArea');
                    
                    if (fileInput) {
                        fileInput.addEventListener('change', handleFileSelect);
                    }
                    
                    if (uploadArea) {
                        // Drag and drop
                        uploadArea.addEventListener('dragover', (e) => {
                            e.preventDefault();
                            uploadArea.classList.add('dragover');
                        });
                        
                        uploadArea.addEventListener('dragleave', () => {
                            uploadArea.classList.remove('dragover');
                        });
                        
                        uploadArea.addEventListener('drop', (e) => {
                            e.preventDefault();
                            uploadArea.classList.remove('dragover');
                            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
                            addFiles(files);
                        });
                    }
                }
        
                function handleFileSelect(e) {
                    const files = Array.from(e.target.files);
                    addFiles(files);
                }
        
                function addFiles(files) {
                    files.forEach(file => {
                        if (file.size > 100 * 1024 * 1024) { // 100MB limit
                            showAlert(`${file.name} is too large. Maximum size is 100MB.`, 'error');
                            return;
                        }
                        if (!selectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                            selectedFiles.push(file);
                        }
                    });
                    
                    updateFileList();
                    updateCreateButton();
                }
        
                function updateFileList() {
                    const fileList = document.getElementById('fileList');
                    if (!fileList) return;
                    
                    fileList.innerHTML = '';
                    
                    selectedFiles.forEach((file, index) => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <div class="file-info">
                                <span>üì∑</span>
                                <span><strong>${file.name}</strong></span>
                                <small style="color: #666;">(${formatFileSize(file.size)})</small>
                            </div>
                            <button class="file-remove" onclick="removeFile(${index})" title="Remove file">√ó</button>
                        `;
                        fileList.appendChild(fileItem);
                    });
                }
        
                function removeFile(index) {
                    selectedFiles.splice(index, 1);
                    updateFileList();
                    updateCreateButton();
                }
        
                function updateCreateButton() {
                    const createBtn = document.getElementById('createBtn');
                    const galleryNameInput = document.getElementById('galleryName');
                    
                    if (createBtn && galleryNameInput) {
                        const galleryName = galleryNameInput.value.trim();
                        createBtn.disabled = !galleryName || selectedFiles.length === 0;
                    }
                }
        
                function formatFileSize(bytes) {
                    if (bytes === 0) return '0 B';
                    const k = 1024;
                    const sizes = ['B', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                }
        
                // Gallery creation functions
                async function createGallery() {
                    const galleryNameInput = document.getElementById('galleryName');
                    if (!galleryNameInput) return;
                    
                    const galleryName = galleryNameInput.value.trim();
                    
                    if (!galleryName || selectedFiles.length === 0) {
                        showAlert('Please enter a gallery name and select photos.', 'error');
                        return;
                    }
        
                    if (!isAuthenticated) {
                        showAlert('Please complete the setup first.', 'error');
                        return;
                    }
        
                    try {
                        showProgress();
                        
                        // Create folder in Google Drive
                        updateProgress('Creating folder in Google Drive...', 10);
                        const folder = await createDriveFolder(galleryName);
                        createdFolderId = folder.id;
                        
                        // Upload files
                        for (let i = 0; i < selectedFiles.length; i++) {
                            const file = selectedFiles[i];
                            const progress = 10 + ((i + 1) / selectedFiles.length) * 70; // 10-80%
                            updateProgress(`Uploading ${file.name}...`, progress);
                            await uploadFileToDrive(file, folder.id);
                        }
                        
                        // Make folder publicly viewable
                        updateProgress('Setting up sharing permissions...', 90);
                        await makeFolderPublic(folder.id);
                        
                        updateProgress('Gallery created successfully!', 100);
                        
                        // Show results
                        setTimeout(() => {
                            hideProgress();
                            showGalleryResult(galleryName, folder.id);
                            nextStep();
                        }, 1500);
                        
                    } catch (error) {
                        hideProgress();
                        console.error('Error creating gallery:', error);
                        showAlert(`Failed to create gallery: ${error.message}`, 'error');
                    }
                }
        
                async function createDriveFolder(name) {
                    const fileMetadata = {
                        name: name,
                        mimeType: 'application/vnd.google-apps.folder'
                    };
                    
                    const response = await gapi.client.drive.files.create({
                        resource: fileMetadata
                    });
                    
                    return response.result;
                }
        
                async function uploadFileToDrive(file, parentId) {
                    const metadata = {
                        name: file.name,
                        parents: [parentId]
                    };
                    
                    const formData = new FormData();
                    formData.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    formData.append('file', file);
                    
                    const accessToken = gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token;
                    
                    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Upload failed: ${response.statusText}`);
                    }
                    
                    return response.json();
                }
        
                async function makeFolderPublic(folderId) {
                    await gapi.client.drive.permissions.create({
                        fileId: folderId,
                        resource: {
                            role: 'reader',
                            type: 'anyone'
                        }
                    });
                }
        
                function showGalleryResult(galleryName, folderId) {
                    const title = document.getElementById('createdGalleryTitle');
                    const shareLink = document.getElementById('shareableLink');
                    const driveLink = document.getElementById('driveLink');
                    
                    if (title) title.textContent = `üì∏ ${galleryName}`;
                    if (shareLink) shareLink.value = `https://drive.google.com/drive/folders/${folderId}?usp=sharing`;
                    if (driveLink) driveLink.value = `https://drive.google.com/drive/folders/${folderId}`;
                }
        
                // Progress functions
                function showProgress() {
                    const uploadProgress = document.getElementById('uploadProgress');
                    if (uploadProgress) {
                        uploadProgress.classList.add('active');
                    }
                }
        
                function hideProgress() {
                    const uploadProgress = document.getElementById('uploadProgress');
                    if (uploadProgress) {
                        uploadProgress.classList.remove('active');
                    }
                }
        
                function updateProgress(message, percent) {
                    const progressList = document.getElementById('progressList');
                    if (progressList) {
                        progressList.innerHTML = `
                            <div class="progress-item">
                                <div class="progress-label">
                                    <span>${message}</span>
                                    <span>${Math.round(percent)}%</span>
                                </div>
                                <div class="progress-bar-small">
                                    <div class="progress-fill-small" style="width: ${percent}%"></div>
                                </div>
                            </div>
                        `;
                    }
                }
        
                // Utility functions
                function showAlert(message, type) {
                    const alertDiv = document.createElement('div');
                    alertDiv.className = `alert alert-${type}`;
                    alertDiv.textContent = message;
                    
                    const content = document.querySelector('.step.active .step-content');
                    if (content) {
                        content.insertBefore(alertDiv, content.firstChild);
                        setTimeout(() => {
                            if (alertDiv && alertDiv.parentNode) {
                                alertDiv.remove();
                            }
                        }, 5000);
                    }
                }
        
                function copyShareLink() {
                    const linkField = document.getElementById('shareableLink');
                    if (!linkField) return;
                    
                    linkField.select();
                    linkField.setSelectionRange(0, 99999);
                    
                    try {
                        document.execCommand('copy');
                        showAlert('Share link copied to clipboard! üìã', 'success');
                    } catch (err) {
                        showAlert('Please manually copy the link', 'error');
                    }
                }
        
                function openDriveFolder() {
                    const driveLink = document.getElementById('driveLink');
                    if (driveLink && driveLink.value) {
                        window.open(driveLink.value, '_blank');
                    }
                }
        
                function createNewGallery() {
                    const galleryNameInput = document.getElementById('galleryName');
                    if (galleryNameInput) galleryNameInput.value = '';
                    
                    selectedFiles = [];
                    updateFileList();
                    updateCreateButton();
                    createdFolderId = '';
                    
                    currentStep = 3;
                    showStep(currentStep);
                }
        
                function resetGalleryForm() {
                    const galleryNameInput = document.getElementById('galleryName');
                    const fileInput = document.getElementById('fileInput');
                    
                    if (galleryNameInput) galleryNameInput.value = '';
                    if (fileInput) fileInput.value = '';
                    
                    selectedFiles = [];
                    updateFileList();
                    updateCreateButton();
                }
        
                // Navigation functions
                function updateProgressBar() {
                    const progressFill = document.getElementById('progressFill');
                    const stepIndicator = document.getElementById('stepIndicator');
                    const prevBtn = document.getElementById('prevBtn');
                    const nextBtn = document.getElementById('nextBtn');
                    
                    const progress = (currentStep / 4) * 100;
                    
                    if (progressFill) progressFill.style.width = progress + '%';
                    if (stepIndicator) stepIndicator.textContent = `Step ${currentStep} of 4`;
                    
                    if (prevBtn) prevBtn.disabled = currentStep === 1;
                    if (nextBtn) nextBtn.style.display = currentStep === 4 ? 'none' : 'block';
                }
        
                function showStep(stepNumber) {
                    // Hide all steps
                    document.querySelectorAll('.step').forEach(step => {
                        step.classList.remove('active');
                    });
                    
                    // Show current step
                    const currentStepElement = document.getElementById(`step${stepNumber}`);
                    if (currentStepElement) {
                        currentStepElement.classList.add('active');
                    }
                    
                    updateProgressBar();
                }
        
                function nextStep() {
                    if (currentStep < 4) {
                        currentStep++;
                        showStep(currentStep);
                    }
                }
        
                function prevStep() {
                    if (currentStep > 1) {
                        currentStep--;
                        showStep(currentStep);
                    }
                }
            </script>
        </body>
        </html>
