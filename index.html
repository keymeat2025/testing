// Watermark toggle function
      function toggleWatermark() {
        watermarkEnabled = !watermarkEnabled;
        const button = document.getElementById('watermark_toggle');
        
        if (watermarkEnabled) {
          button.textContent = 'üè∑Ô∏è Watermark: ON';
          button.style.backgroundColor = '#34a853';
        } else {
          button.textContent = 'üè∑Ô∏è Watermark: OFF';
          button.style.backgroundColor = '#4285f4';
        }
        
        // Update existing images without re-rendering - just toggle watermark classes
        if (currentView === 'images') {
          const imageItems = document.querySelectorAll('.image-item');
          
          imageItems.forEach((imageDiv, index) => {
            if (watermarkEnabled) {
              // Add watermark classes
              imageDiv.classList.add('watermarked');
              
              // Add random positioning and opacity for variety
              const randomPos = Math.floor(Math.random() * 6) + 1;
              const randomOpacity = Math.floor(Math.random() *<!DOCTYPE html>
<html>
  <head>
    <title>Google Drive Folder & Image Browser</title>
    <meta charset="utf-8" />
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .navigation {
        margin: 20px 0;
        padding: 10px;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      .breadcrumb {
        color: #666;
        margin-bottom: 10px;
      }
      .back-button {
        background-color: #666;
        margin-right: 10px;
      }
      .folder-grid, .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }
      .folder-item {
        border: 2px solid #4285f4;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #f8f9ff;
      }
      .folder-item:hover {
        background-color: #e8f0fe;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      }
      .folder-icon {
        font-size: 48px;
        margin-bottom: 10px;
      }
      .folder-name {
        font-weight: bold;
        word-break: break-word;
        margin-bottom: 5px;
      }
      .folder-count {
        color: #666;
        font-size: 12px;
      }
      .image-item {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        text-align: center;
        background-color: white;
      }
      .image-item img {
        max-width: 100%;
        max-height: 200px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
      }
      
      /* Modal styles for image gallery */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.9);
      }
      
      .modal-content {
        position: relative;
        margin: auto;
        padding: 0;
        width: 90%;
        max-width: 1200px;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .modal-image {
        max-width: 100%;
        max-height: 90vh;
        object-fit: contain;
      }
      
      .close {
        position: absolute;
        top: 15px;
        right: 35px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1001;
      }
      
      .close:hover {
        color: #bbb;
      }
      
      .prev, .next {
        position: absolute;
        top: 50%;
        width: auto;
        padding: 16px;
        margin-top: -50px;
        color: white;
        font-weight: bold;
        font-size: 18px;
        background-color: rgba(0,0,0,0.5);
        border: none;
        cursor: pointer;
        user-select: none;
        z-index: 1001;
      }
      
      .next {
        right: 0;
        border-radius: 3px 0 0 3px;
      }
      
      .prev {
        left: 0;
        border-radius: 0 3px 3px 0;
      }
      
      .prev:hover, .next:hover {
        background-color: rgba(0,0,0,0.8);
      }
      
      .modal-info {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        background-color: rgba(0,0,0,0.7);
        padding: 10px 20px;
        border-radius: 5px;
      }
      
      .image-counter {
        font-size: 14px;
        margin-bottom: 5px;
      }
      
      .image-title {
        font-size: 16px;
        font-weight: bold;
      }
      
      /* Watermark styles */
      .watermarked {
        position: relative;
      }
      
      .watermarked::after {
        content: 'snapselect';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 12px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.3);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.4);
        pointer-events: none;
        z-index: 10;
        letter-spacing: 2px;
        text-transform: lowercase;
      }
      
      .watermarked img {
        filter: none; /* Remove the darkening effect */
      }
      
      /* Modal watermark */
      .modal-watermarked::after {
        content: 'snapselect';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) rotate(-45deg);
        font-size: 24px;
        font-weight: bold;
        color: rgba(255, 255, 255, 0.25);
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        pointer-events: none;
        z-index: 1002;
        letter-spacing: 4px;
        text-transform: lowercase;
      }
      
      /* Random positioning classes */
      .watermarked.pos-1::after { top: 30%; left: 30%; }
      .watermarked.pos-2::after { top: 70%; left: 70%; }
      .watermarked.pos-3::after { top: 25%; left: 65%; }
      .watermarked.pos-4::after { top: 75%; left: 35%; }
      .watermarked.pos-5::after { top: 40%; left: 20%; }
      .watermarked.pos-6::after { top: 60%; left: 80%; }
      
      /* Random opacity classes */
      .watermarked.opacity-1::after { opacity: 0.2; }
      .watermarked.opacity-2::after { opacity: 0.3; }
      .watermarked.opacity-3::after { opacity: 0.25; }
      .watermarked.opacity-4::after { opacity: 0.35; }
      .image-name {
        margin-top: 10px;
        font-weight: bold;
        word-break: break-word;
        font-size: 14px;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        background-color: #4285f4;
        color: white;
        cursor: pointer;
      }
      button:hover {
        background-color: #3367d6;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .loading {
        text-align: center;
        margin: 20px;
        color: #666;
      }
      .empty-state {
        text-align: center;
        margin: 40px;
        color: #666;
      }
      .view-toggle {
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <h1>Google Drive Folder & Image Browser</h1>
    <p>Browse folders first, then view images inside them</p>

    <div class="view-toggle">
      <button id="authorize_button" onclick="handleAuthClick()">Authorize</button>
      <button id="signout_button" onclick="handleSignoutClick()">Sign Out</button>
      <button id="load_folders_button" onclick="loadFolders()" disabled>Browse Folders</button>
      <button id="watermark_toggle" onclick="toggleWatermark()" disabled>üè∑Ô∏è Watermark: OFF</button>
    </div>

    <div id="navigation" class="navigation" style="display: none;">
      <div id="breadcrumb" class="breadcrumb"></div>
      <button id="back_button" class="back-button" onclick="goBack()" style="display: none;">‚Üê Back</button>
      <button onclick="loadFolders()">üìÅ Show Folders</button>
    </div>

    <div id="loading" class="loading" style="display: none;">Loading...</div>
    <div id="content-container"></div>

    <!-- Image Modal/Gallery -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <button class="prev" onclick="changeImage(-1)">&#10094;</button>
        <img id="modalImage" class="modal-image" src="" alt="">
        <button class="next" onclick="changeImage(1)">&#10095;</button>
        <div class="modal-info">
          <div id="imageCounter" class="image-counter"></div>
          <div id="imageTitle" class="image-title"></div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      const CLIENT_ID = '790992026707-a2ah00pav4gjq6u7m3au3amn9ij12hes.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyB0FkpFoTRWOXc8b6_gCzEKCoWMDcuA7NQ';
      const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest';
      const SCOPES = 'https://www.googleapis.com/auth/drive.readonly';

      let tokenClient;
      let gapiInited = false;
      let gisInited = false;
      let currentFolderId = 'root';
      let folderHistory = [];
      let currentView = 'folders'; // 'folders' or 'images'
      let currentImages = []; // Store current folder's images for gallery
      let currentImageIndex = 0; // Current image in gallery
      let watermarkEnabled = false; // Watermark toggle state

      const IMAGE_MIME_TYPES = [
        'image/jpeg', 'image/jpg', 'image/png', 'image/gif',
        'image/webp', 'image/bmp', 'image/svg+xml', 'image/tiff'
      ];

      document.getElementById('authorize_button').style.visibility = 'hidden';
      document.getElementById('signout_button').style.visibility = 'hidden';

      function gapiLoaded() {
        gapi.load('client', initializeGapiClient);
      }

      async function initializeGapiClient() {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [DISCOVERY_DOC],
        });
        gapiInited = true;
        maybeEnableButtons();
      }

      function gisLoaded() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: '',
        });
        gisInited = true;
        maybeEnableButtons();
      }

      function maybeEnableButtons() {
        if (gapiInited && gisInited) {
          document.getElementById('authorize_button').style.visibility = 'visible';
        }
      }

      function handleAuthClick() {
        tokenClient.callback = async (resp) => {
          if (resp.error !== undefined) {
            throw (resp);
          }
          document.getElementById('signout_button').style.visibility = 'visible';
          document.getElementById('load_folders_button').disabled = false;
          document.getElementById('watermark_toggle').disabled = false;
          document.getElementById('authorize_button').innerText = 'Refresh';
          document.getElementById('navigation').style.display = 'block';
        };

        if (gapi.client.getToken() === null) {
          tokenClient.requestAccessToken({prompt: 'consent'});
        } else {
          tokenClient.requestAccessToken({prompt: ''});
        }
      }

      function handleSignoutClick() {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token);
          gapi.client.setToken('');
          document.getElementById('content-container').innerHTML = '';
          document.getElementById('navigation').style.display = 'none';
          document.getElementById('authorize_button').innerText = 'Authorize';
          document.getElementById('signout_button').style.visibility = 'hidden';
          document.getElementById('load_folders_button').disabled = true;
          document.getElementById('watermark_toggle').disabled = true;
          resetNavigation();
        }
      }

      function resetNavigation() {
        currentFolderId = 'root';
        folderHistory = [];
        currentView = 'folders';
        updateBreadcrumb();
      }

      function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        const backButton = document.getElementById('back_button');
        
        if (currentFolderId === 'root') {
          breadcrumb.textContent = `üìÅ Root Folder - Viewing: ${currentView}`;
          backButton.style.display = 'none';
        } else {
          breadcrumb.textContent = `üìÅ Current Folder - Viewing: ${currentView}`;
          backButton.style.display = 'inline-block';
        }
      }

      function goBack() {
        if (folderHistory.length > 0) {
          currentFolderId = folderHistory.pop();
          if (currentView === 'images') {
            loadImagesInFolder(currentFolderId);
          } else {
            loadFolders(currentFolderId);
          }
        }
      }

      async function loadFolders(folderId = 'root') {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content-container').innerHTML = '';
        currentView = 'folders';
        currentFolderId = folderId;
        updateBreadcrumb();

        try {
          const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            pageSize: 100,
            fields: 'files(id, name)',
            orderBy: 'name'
          });

          const folders = response.result.files || [];
          await displayFolders(folders);

        } catch (err) {
          console.error('Error loading folders:', err);
          document.getElementById('loading').textContent = 'Error loading folders: ' + err.message;
        }
      }

      async function displayFolders(folders) {
        const container = document.getElementById('content-container');
        document.getElementById('loading').style.display = 'none';

        if (folders.length === 0) {
          container.innerHTML = '<div class="empty-state">No folders found in this location.</div>';
          return;
        }

        const folderGrid = document.createElement('div');
        folderGrid.className = 'folder-grid';

        for (const folder of folders) {
          // Count images in this folder
          const imageCount = await countImagesInFolder(folder.id);
          
          const folderDiv = document.createElement('div');
          folderDiv.className = 'folder-item';
          folderDiv.onclick = () => openFolder(folder.id, folder.name);

          folderDiv.innerHTML = `
            <div class="folder-icon">üìÅ</div>
            <div class="folder-name">${folder.name}</div>
            <div class="folder-count">${imageCount} images</div>
          `;

          folderGrid.appendChild(folderDiv);
        }

        const summary = document.createElement('p');
        summary.textContent = `Found ${folders.length} folders`;
        summary.style.textAlign = 'center';
        summary.style.color = '#666';

        container.appendChild(summary);
        container.appendChild(folderGrid);
      }

      async function countImagesInFolder(folderId) {
        try {
          const mimeTypeQuery = IMAGE_MIME_TYPES.map(type => `mimeType='${type}'`).join(' or ');
          const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and (${mimeTypeQuery}) and trashed=false`,
            pageSize: 1000,
            fields: 'files(id)'
          });
          return response.result.files ? response.result.files.length : 0;
        } catch (err) {
          return 0;
        }
      }

      function openFolder(folderId, folderName) {
        folderHistory.push(currentFolderId);
        loadImagesInFolder(folderId);
      }

      async function loadImagesInFolder(folderId) {
        document.getElementById('loading').style.display = 'block';
        document.getElementById('content-container').innerHTML = '';
        currentView = 'images';
        currentFolderId = folderId;
        updateBreadcrumb();

        try {
          const mimeTypeQuery = IMAGE_MIME_TYPES.map(type => `mimeType='${type}'`).join(' or ');
          
          const response = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and (${mimeTypeQuery}) and trashed=false`,
            pageSize: 100,
            fields: 'files(id, name, mimeType, thumbnailLink, webViewLink)',
            orderBy: 'name'
          });

          const images = response.result.files || [];
          currentImages = images; // Store for gallery navigation
          displayImages(images);

        } catch (err) {
          console.error('Error loading images:', err);
          document.getElementById('loading').textContent = 'Error loading images: ' + err.message;
        }
      }

      function displayImages(images) {
        const container = document.getElementById('content-container');
        document.getElementById('loading').style.display = 'none';

        if (images.length === 0) {
          container.innerHTML = '<div class="empty-state">No images found in this folder.</div>';
          return;
        }

        const imageGrid = document.createElement('div');
        imageGrid.className = 'image-grid';

        images.forEach((image, index) => {
          const imageDiv = document.createElement('div');
          imageDiv.className = 'image-item';
          
          // Add watermark class if enabled - this is ONLY for display, doesn't affect the actual file
          if (watermarkEnabled) {
            imageDiv.classList.add('watermarked');
            
            // Add random positioning and opacity for variety
            const randomPos = Math.floor(Math.random() * 6) + 1;
            const randomOpacity = Math.floor(Math.random() * 4) + 1;
            imageDiv.classList.add(`pos-${randomPos}`, `opacity-${randomOpacity}`);
          }

          const imgElement = document.createElement('img');
          
          // Use original image URLs - watermark is only CSS overlay for display
          if (image.thumbnailLink) {
            imgElement.src = image.thumbnailLink;
          } else {
            imgElement.src = `https://drive.google.com/thumbnail?id=${image.id}&sz=w300`;
          }
          
          imgElement.alt = image.name;
          imgElement.onerror = function() {
            this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+';
          };

          // Open gallery instead of Google Drive
          imgElement.onclick = function() {
            openImageGallery(index);
          };

          const nameDiv = document.createElement('div');
          nameDiv.className = 'image-name';
          nameDiv.textContent = image.name;

          imageDiv.appendChild(imgElement);
          imageDiv.appendChild(nameDiv);
          imageGrid.appendChild(imageDiv);
        });

        const summary = document.createElement('p');
        summary.textContent = `Found ${images.length} images in this folder`;
        summary.style.textAlign = 'center';
        summary.style.color = '#666';

        container.appendChild(summary);
        container.appendChild(imageGrid);
      }

      // Gallery functions
      function openImageGallery(index) {
        currentImageIndex = index;
        const modal = document.getElementById('imageModal');
        updateModalImage();
        modal.style.display = 'block';
        
        // Add keyboard navigation
        document.addEventListener('keydown', handleKeyNavigation);
      }

      function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.style.display = 'none';
        document.removeEventListener('keydown', handleKeyNavigation);
      }

      function changeImage(direction) {
        currentImageIndex += direction;
        
        // Wrap around
        if (currentImageIndex >= currentImages.length) {
          currentImageIndex = 0;
        } else if (currentImageIndex < 0) {
          currentImageIndex = currentImages.length - 1;
        }
        
        updateModalImage();
      }

      function updateModalImage() {
        if (currentImages.length === 0) return;
        
        const image = currentImages[currentImageIndex];
        const modalImage = document.getElementById('modalImage');
        const imageCounter = document.getElementById('imageCounter');
        const imageTitle = document.getElementById('imageTitle');
        const modalContent = document.querySelector('.modal-content');
        
        // Add/remove watermark class for modal
        if (watermarkEnabled) {
          modalContent.classList.add('modal-watermarked');
        } else {
          modalContent.classList.remove('modal-watermarked');
        }
        
        // Use higher resolution image for modal
        if (image.thumbnailLink) {
          // Try to get a larger thumbnail
          modalImage.src = image.thumbnailLink.replace(/=s\d+/, '=s800');
        } else {
          modalImage.src = `https://drive.google.com/thumbnail?id=${image.id}&sz=w800`;
        }
        
        // Update info
        imageCounter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
        imageTitle.textContent = image.name;
        
        // Fallback to try direct image URL if thumbnail fails
        modalImage.onerror = function() {
          // Try the direct file view URL as a last resort
          this.src = `https://drive.google.com/uc?id=${image.id}`;
        };
      }

      function handleKeyNavigation(event) {
        switch(event.key) {
          case 'ArrowLeft':
            changeImage(-1);
            break;
          case 'ArrowRight':
            changeImage(1);
            break;
          case 'Escape':
            closeModal();
            break;
        }
      }

      // Close modal when clicking outside the image
      window.onclick = function(event) {
        const modal = document.getElementById('imageModal');
        if (event.target === modal) {
          closeModal();
        }
      }

      // Watermark toggle function
      function toggleWatermark() {
        watermarkEnabled = !watermarkEnabled;
        const button = document.getElementById('watermark_toggle');
        
        if (watermarkEnabled) {
          button.textContent = 'üè∑Ô∏è Watermark: ON';
          button.style.backgroundColor = '#34a853';
        } else {
          button.textContent = 'üè∑Ô∏è Watermark: OFF';
          button.style.backgroundColor = '#4285f4';
        }
        
        // Update existing images without re-rendering - just toggle watermark classes
        if (currentView === 'images') {
          const imageItems = document.querySelectorAll('.image-item');
          
          imageItems.forEach((imageDiv, index) => {
            if (watermarkEnabled) {
              // Add watermark classes
              imageDiv.classList.add('watermarked');
              
              // Remove any existing position/opacity classes first
              imageDiv.classList.remove('pos-1', 'pos-2', 'pos-3', 'pos-4', 'pos-5', 'pos-6');
              imageDiv.classList.remove('opacity-1', 'opacity-2', 'opacity-3', 'opacity-4');
              
              // Add random positioning and opacity for variety
              const randomPos = Math.floor(Math.random() * 6) + 1;
              const randomOpacity = Math.floor(Math.random() * 4) + 1;
              imageDiv.classList.add(`pos-${randomPos}`, `opacity-${randomOpacity}`);
            } else {
              // Remove watermark classes
              imageDiv.classList.remove('watermarked');
              imageDiv.classList.remove('pos-1', 'pos-2', 'pos-3', 'pos-4', 'pos-5', 'pos-6');
              imageDiv.classList.remove('opacity-1', 'opacity-2', 'opacity-3', 'opacity-4');
            }
          });
          
          // Also update modal if it's open
          const modalContent = document.querySelector('.modal-content');
          if (modalContent) {
            if (watermarkEnabled) {
              modalContent.classList.add('modal-watermarked');
            } else {
              modalContent.classList.remove('modal-watermarked');
            }
          }
        }
      }
    </script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  </body>
</html>
