<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Google Cloud Setup - Fixed & Compliant</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .content {
            padding: 40px;
        }

        .setup-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #ffeaa7;
        }

        .setup-section h3 {
            color: #856404;
            margin-bottom: 15px;
        }

        .setup-section p {
            color: #856404;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .setup-code {
            background: #343a40;
            color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 10px 0;
            overflow-x: auto;
        }

        .auth-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }

        .test-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #4285f4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .test-section.active {
            border-left-color: #ffc107;
            background: #fffcf0;
        }

        .test-section.completed {
            border-left-color: #34a853;
            background: #f8fff8;
        }

        .test-section.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .test-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .test-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-pending {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-active {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .test-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .test-button {
            background: #4285f4;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .test-button:hover:not(:disabled) {
            background: #3367d6;
            transform: translateY(-1px);
        }

        .test-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .test-button.retry {
            background: #dc3545;
        }

        .test-button.retry:hover:not(:disabled) {
            background: #c82333;
        }

        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .test-result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 0.9rem;
            border: 1px solid #dee2e6;
            display: none;
            white-space: pre-wrap;
        }

        .test-result.show {
            display: block;
        }

        .test-result.success {
            background: #f8fff8;
            border-color: #34a853;
            color: #155724;
        }

        .test-result.error {
            background: #fff5f5;
            border-color: #dc3545;
            color: #721c24;
        }

        .popup-info {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid #b8daff;
        }

        .popup-status {
            font-weight: bold;
            color: #004085;
            margin-bottom: 10px;
        }

        .popup-details {
            color: #495057;
            font-size: 0.95rem;
        }

        .auth-button {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
        }

        .auth-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .user-info {
            background: #f8fff8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #34a853;
            display: none;
        }

        .user-info.show {
            display: block;
        }

        .config-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .config-label {
            font-weight: bold;
            color: #495057;
        }

        .config-value {
            font-family: monospace;
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
            color: #495057;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .instructions {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #b8daff;
        }

        .instructions h4 {
            color: #004085;
            margin-bottom: 10px;
        }

        .instructions ol {
            color: #004085;
            padding-left: 20px;
        }

        .instructions li {
            margin: 5px 0;
        }

        .config-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: monospace;
        }

        .config-input:focus {
            outline: none;
            border-color: #4285f4;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .test-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .config-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .config-value {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Fixed Google Cloud Setup Tester</h1>
            <p>Using Google Identity Services (GIS) - Compliant & Working</p>
        </div>

        <div class="content">
            <!-- Setup Instructions -->
            <div class="setup-section">
                <h3>🔧 Fixed Setup - No More Errors!</h3>
                <p><strong>This version fixes all the JavaScript and Google API issues:</strong></p>
                
                <ul style="color: #856404; padding-left: 20px; margin: 15px 0;">
                    <li>✅ Uses Google Identity Services (GIS) instead of deprecated gapi.auth2</li>
                    <li>✅ Fixes "Cannot access before initialization" error</li>
                    <li>✅ Proper class declaration order</li>
                    <li>✅ Compatible with modern Google APIs</li>
                </ul>
                
                <p><strong>Setup your OAuth Client ID:</strong></p>
                <ol style="color: #856404; padding-left: 20px; margin: 15px 0;">
                    <li>Go to <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #856404;">Google Cloud Console → Credentials</a></li>
                    <li>Create OAuth 2.0 Client ID (Web application)</li>
                    <li>Add this origin to "Authorized JavaScript origins":</li>
                </ol>
                
                <div class="setup-code" id="currentOrigin">
                    <!-- Will be filled by JavaScript -->
                </div>
                
                <p><strong>Paste your Client ID:</strong></p>
                <input type="text" class="config-input" id="clientIdInput" placeholder="123456789-abcdefghijk.apps.googleusercontent.com">
                <button class="test-button" onclick="saveClientId()" style="margin-top: 10px;">💾 Save Client ID</button>
            </div>

            <!-- Authentication Section -->
            <div class="auth-section">
                <h3>🔐 Step 1: Google Identity Services Authentication</h3>
                <p>Using the new, compliant Google Identity Services API for authentication.</p>
                
                <button class="auth-button" id="authButton" onclick="authenticateUser()" disabled>
                    🚀 Authenticate with Google (GIS API)
                </button>
                
                <div class="user-info" id="userInfo">
                    <h4>✅ Authenticated Successfully</h4>
                    <div class="config-section">
                        <div class="config-item">
                            <span class="config-label">User:</span>
                            <span class="config-value" id="userName">-</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Email:</span>
                            <span class="config-value" id="userEmail">-</span>
                        </div>
                        <div class="config-item">
                            <span class="config-label">Access Token:</span>
                            <span class="config-value" id="accessToken">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Test 1: Project Creation -->
            <div class="test-section" id="test1">
                <div class="test-header">
                    <div class="test-title">
                        🏗️ Test 1: Real Project Creation Detection
                    </div>
                    <div class="test-status status-pending" id="test1Status">
                        Pending
                    </div>
                </div>
                <div class="test-description">
                    Opens Google Cloud Console for project creation, uses real Resource Manager API for detection.
                </div>
                
                <div class="instructions">
                    <h4>📝 Test Instructions:</h4>
                    <ol>
                        <li>Click the test button</li>
                        <li>Create a project with "test" or "studio" in the name</li>
                        <li>Close the popup when done</li>
                        <li>Watch real API detection in action</li>
                    </ol>
                </div>
                
                <button class="test-button" id="test1Button" onclick="testProjectCreation()" disabled>
                    🚀 Test Project Creation
                </button>
                
                <div class="popup-info" id="test1PopupInfo" style="display: none;">
                    <div class="popup-status">Status: <span id="test1PopupStatus">-</span></div>
                    <div class="popup-details">Real Resource Manager API monitoring...</div>
                </div>
                
                <div class="test-result" id="test1Result"></div>
            </div>

            <!-- Test 2: API Enablement -->
            <div class="test-section" id="test2">
                <div class="test-header">
                    <div class="test-title">
                        🔌 Test 2: API Enablement Detection
                    </div>
                    <div class="test-status status-pending" id="test2Status">
                        Pending
                    </div>
                </div>
                <div class="test-description">
                    Opens Google Drive API page, uses real Service Usage API for detection.
                </div>
                
                <button class="test-button" id="test2Button" onclick="testAPIEnablement()" disabled>
                    🔌 Test API Enablement
                </button>
                
                <div class="popup-info" id="test2PopupInfo" style="display: none;">
                    <div class="popup-status">Status: <span id="test2PopupStatus">-</span></div>
                    <div class="popup-details">Real Service Usage API monitoring...</div>
                </div>
                
                <div class="test-result" id="test2Result"></div>
            </div>
        </div>
    </div>

    <script>
        // Secure Google Cloud Setup Class - Defined First
        class SecureGoogleCloudSetup {
            constructor() {
                this.activePopups = new Map();
                this.accessToken = null;
            }

            setAccessToken(token) {
                this.accessToken = token;
            }

            async executeSecureTask(taskConfig) {
                const { url, taskName, completionCheck } = taskConfig;
                
                console.log(`Starting secure task: ${taskName}`);
                this.updatePopupStatus(taskName, 'Opening popup...');
                
                const popup = window.open(
                    url,
                    `gcp_${taskName}`,
                    'width=1400,height=900,scrollbars=yes,toolbar=yes,location=yes,menubar=yes'
                );

                if (!popup) {
                    throw new Error('Popup blocked. Please allow popups and try again.');
                }

                this.activePopups.set(taskName, popup);
                return this.monitorTaskCompletion(taskName, completionCheck, popup);
            }

            async monitorTaskCompletion(taskName, completionCheck, popup) {
                return new Promise((resolve, reject) => {
                    let checkCount = 0;
                    const maxChecks = 150; // 5 minutes
                    
                    const checkInterval = setInterval(async () => {
                        checkCount++;
                        
                        try {
                            if (popup.closed) {
                                this.updatePopupStatus(taskName, 'Popup closed - checking completion...');
                                clearInterval(checkInterval);
                                
                                setTimeout(async () => {
                                    try {
                                        const result = await completionCheck();
                                        if (result) {
                                            this.updatePopupStatus(taskName, 'Completed!');
                                            resolve(result);
                                        } else {
                                            this.updatePopupStatus(taskName, 'Not completed');
                                            reject(new Error(`Task ${taskName} not completed`));
                                        }
                                    } catch (error) {
                                        reject(error);
                                    }
                                }, 3000);
                                return;
                            }
                            
                            this.updatePopupStatus(taskName, `Monitoring... (${checkCount}/${maxChecks})`);
                            
                            // Check completion every 10 seconds while popup is open
                            if (checkCount % 5 === 0) {
                                try {
                                    const result = await completionCheck();
                                    if (result) {
                                        clearInterval(checkInterval);
                                        popup.close();
                                        resolve(result);
                                        return;
                                    }
                                } catch (error) {
                                    // Expected during polling
                                }
                            }
                            
                            if (checkCount >= maxChecks) {
                                clearInterval(checkInterval);
                                if (!popup.closed) popup.close();
                                reject(new Error(`Task ${taskName} timed out`));
                            }
                            
                        } catch (error) {
                            clearInterval(checkInterval);
                            if (!popup.closed) popup.close();
                            reject(error);
                        }
                    }, 2000);
                });
            }

            updatePopupStatus(taskName, status) {
                const statusElement = document.getElementById(`${taskName}PopupStatus`);
                if (statusElement) {
                    statusElement.textContent = status;
                }
            }

            async checkProjectCreation() {
                try {
                    const response = await fetch('https://cloudresourcemanager.googleapis.com/v1/projects', {
                        headers: { 'Authorization': `Bearer ${this.accessToken}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // Look for recent projects
                    const recentProjects = data.projects?.filter(p => {
                        const createTime = new Date(p.createTime);
                        const timeDiff = Date.now() - createTime.getTime();
                        return timeDiff < 600000; // 10 minutes
                    }) || [];
                    
                    if (recentProjects.length > 0) {
                        return recentProjects[0];
                    }
                    
                    return false;
                } catch (error) {
                    console.error('Project check error:', error);
                    throw error;
                }
            }

            async checkAPIEnabled(projectId) {
                try {
                    const response = await fetch(
                        `https://serviceusage.googleapis.com/v1/projects/${projectId}/services/drive.googleapis.com`,
                        { headers: { 'Authorization': `Bearer ${this.accessToken}` } }
                    );
                    
                    if (!response.ok) {
                        if (response.status === 404) return false;
                        throw new Error(`API Error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data.state === 'ENABLED' ? data : false;
                } catch (error) {
                    console.error('API check error:', error);
                    throw error;
                }
            }
        }

        // Global variables - Declared after class
        let CLIENT_ID = null;
        let accessToken = null;
        let userProfile = null;
        let createdProjectId = null;
        const secureSetup = new SecureGoogleCloudSetup();

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentOrigin').textContent = window.location.origin;
            
            const savedClientId = localStorage.getItem('fixedClientId');
            if (savedClientId) {
                document.getElementById('clientIdInput').value = savedClientId;
                CLIENT_ID = savedClientId;
                document.getElementById('authButton').disabled = false;
            }
        });

        function saveClientId() {
            const clientId = document.getElementById('clientIdInput').value.trim();
            if (clientId && clientId.includes('.apps.googleusercontent.com')) {
                CLIENT_ID = clientId;
                localStorage.setItem('fixedClientId', clientId);
                document.getElementById('authButton').disabled = false;
                alert('✅ Client ID saved! Ready to authenticate.');
            } else {
                alert('❌ Please enter a valid Client ID');
            }
        }

        function authenticateUser() {
            if (!CLIENT_ID) {
                alert('Please save your Client ID first.');
                return;
            }

            const authButton = document.getElementById('authButton');
            authButton.disabled = true;
            authButton.textContent = '🔄 Initializing Google Identity Services...';

            try {
                // Initialize Google Identity Services
                google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/cloudplatformprojects https://www.googleapis.com/auth/cloud-platform https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email',
                    callback: async (response) => {
                        try {
                            if (response.error) {
                                throw new Error(response.error);
                            }

                            accessToken = response.access_token;
                            secureSetup.setAccessToken(accessToken);

                            // Get user info
                            const userResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                                headers: { 'Authorization': `Bearer ${accessToken}` }
                            });

                            if (userResponse.ok) {
                                userProfile = await userResponse.json();
                                
                                // Update UI
                                document.getElementById('userName').textContent = userProfile.name;
                                document.getElementById('userEmail').textContent = userProfile.email;
                                document.getElementById('accessToken').textContent = accessToken.substring(0, 30) + '...';
                                document.getElementById('userInfo').classList.add('show');
                                
                                // Enable tests
                                document.getElementById('test1Button').disabled = false;
                                
                                authButton.textContent = '✅ Authenticated with GIS';
                                authButton.style.background = '#34a853';
                            }

                        } catch (error) {
                            console.error('Auth callback error:', error);
                            authButton.disabled = false;
                            authButton.textContent = '❌ Auth Failed - Retry';
                            authButton.style.background = '#dc3545';
                        }
                    }
                }).requestAccessToken();

            } catch (error) {
                console.error('GIS initialization error:', error);
                authButton.disabled = false;
                authButton.textContent = '❌ GIS Error - Retry';
                authButton.style.background = '#dc3545';
            }
        }

        async function testProjectCreation() {
            const testSection = document.getElementById('test1');
            const testButton = document.getElementById('test1Button');
            const testStatus = document.getElementById('test1Status');
            const testResult = document.getElementById('test1Result');
            const popupInfo = document.getElementById('test1PopupInfo');
            
            testSection.classList.add('active');
            testButton.disabled = true;
            testStatus.className = 'test-status status-active';
            testStatus.innerHTML = '<div class="spinner"></div> Active';
            popupInfo.style.display = 'block';
            
            try {
                const result = await secureSetup.executeSecureTask({
                    url: 'https://console.cloud.google.com/projectcreate',
                    taskName: 'test1',
                    completionCheck: () => secureSetup.checkProjectCreation()
                });
                
                createdProjectId = result.projectId;
                
                testSection.classList.remove('active');
                testSection.classList.add('completed');
                testStatus.className = 'test-status status-completed';
                testStatus.textContent = '✅ Completed';
                
                testResult.className = 'test-result success show';
                testResult.textContent = `✅ PROJECT CREATED SUCCESSFULLY!

Real API Detection Results:
• Project ID: ${result.projectId}
• Project Name: ${result.name}
• Lifecycle State: ${result.lifecycleState}
• Created: ${result.createTime}

This used REAL Google Cloud Resource Manager API!`;
                
                document.getElementById('test2Button').disabled = false;
                
            } catch (error) {
                testSection.classList.remove('active');
                testSection.classList.add('error');
                testStatus.className = 'test-status status-error';
                testStatus.textContent = '❌ Failed';
                
                testResult.className = 'test-result error show';
                testResult.textContent = `❌ ERROR: ${error.message}

Common causes:
• Project creation not completed
• Insufficient permissions  
• Network/API issues`;
                
                testButton.textContent = '🔄 Retry';
                testButton.className = 'test-button retry';
                testButton.disabled = false;
            }
        }

        async function testAPIEnablement() {
            if (!createdProjectId) {
                alert('Complete Test 1 first.');
                return;
            }
            
            const testSection = document.getElementById('test2');
            const testButton = document.getElementById('test2Button');
            const testStatus = document.getElementById('test2Status');
            const testResult = document.getElementById('test2Result');
            const popupInfo = document.getElementById('test2PopupInfo');
            
            testSection.classList.add('active');
            testButton.disabled = true;
            testStatus.className = 'test-status status-active';
            testStatus.innerHTML = '<div class="spinner"></div> Active';
            popupInfo.style.display = 'block';
            
            try {
                const result = await secureSetup.executeSecureTask({
                    url: `https://console.cloud.google.com/apis/library/drive.googleapis.com?project=${createdProjectId}`,
                    taskName: 'test2',
                    completionCheck: () => secureSetup.checkAPIEnabled(createdProjectId)
                });
                
                testSection.classList.remove('active');
                testSection.classList.add('completed');
                testStatus.className = 'test-status status-completed';
                testStatus.textContent = '✅ Completed';
                
                testResult.className = 'test-result success show';
                testResult.textContent = `✅ GOOGLE DRIVE API ENABLED!

Real API Detection Results:
• Project: ${createdProjectId}
• Service: ${result.name}
• State: ${result.state}

This used REAL Google Service Usage API!`;
                
            } catch (error) {
                testSection.classList.remove('active');
                testSection.classList.add('error');
                testStatus.className = 'test-status status-error';
                testStatus.textContent = '❌ Failed';
                
                testResult.className = 'test-result error show';
                testResult.textContent = `❌ ERROR: ${error.message}

Common causes:
• API not enabled in popup
• Permission issues
• Invalid project ID`;
                
                testButton.textContent = '🔄 Retry';
                testButton.className = 'test-button retry';
                testButton.disabled = false;
            }
        }
    </script>
</body>
</html>
