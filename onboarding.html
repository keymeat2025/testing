<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Studio Gallery Creator - Automated Setup</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4285f4 0%, #34a853 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .step {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .step.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .step-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .step-number {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            margin-right: 20px;
        }

        .step-title {
            font-size: 1.8rem;
            color: #333;
            font-weight: 300;
        }

        .step-content {
            font-size: 1.1rem;
            line-height: 1.6;
            color: #555;
            margin-bottom: 30px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(66, 133, 244, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #4285f4;
            border: 2px solid #4285f4;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4285f4;
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4285f4, #34a853);
            transition: width 0.5s ease;
            border-radius: 4px;
        }

        .automation-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            border: 2px solid #e0e0e0;
        }

        .automation-step {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #4285f4;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .automation-step.completed {
            border-left-color: #34a853;
            background: #f8fff8;
        }

        .automation-step.processing {
            border-left-color: #ffc107;
            background: #fffcf0;
        }

        .automation-step h4 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }

        .step-number-small {
            background: #4285f4;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: bold;
        }

        .step-number-small.completed {
            background: #34a853;
        }

        .step-number-small.processing {
            background: #ffc107;
        }

        .embedded-console {
            width: 100%;
            height: 500px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            margin: 20px 0;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-info {
            background: #cce7ff;
            color: #004085;
            border: 1px solid #99d6ff;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4285f4;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.1);
        }

        .credential-detector {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #b8daff;
        }

        .auto-complete-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .file-upload-area {
            border: 3px dashed #4285f4;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            transition: all 0.3s ease;
            cursor: pointer;
            margin: 20px 0;
        }

        .file-upload-area:hover {
            background: #e9ecef;
            border-color: #34a853;
        }

        .file-upload-area.dragover {
            background: #e8f5e8;
            border-color: #34a853;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #4285f4;
        }

        .file-list {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 18px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-remove:hover {
            background: #c82333;
        }

        .gallery-result {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #e8f5e8;
        }

        .share-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .copy-link-container {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .link-display {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: white;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-link-btn {
            padding: 12px 20px;
            background: #34a853;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            white-space: nowrap;
        }

        .copy-link-btn:hover {
            background: #2d8f47;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .nav-btn {
            background: none;
            border: none;
            color: #4285f4;
            font-size: 1rem;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 25px;
            transition: all 0.3s ease;
        }

        .nav-btn:hover:not(:disabled) {
            background: rgba(66, 133, 244, 0.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .automation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .status-pending {
            background: #e9ecef;
            color: #6c757d;
        }

        .status-processing {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                justify-content: center;
            }
            
            .copy-link-container {
                flex-direction: column;
            }
            
            .embedded-console {
                height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ Fully Automated Studio Setup</h1>
            <p>One-click Google Cloud setup for professional photo galleries</p>
        </div>

        <div class="content">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <!-- Step 1: Introduction -->
            <div class="step active" id="step1">
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Automated Studio Setup</div>
                </div>
                <div class="step-content">
                    <div class="alert alert-info">
                        <strong>üéØ Fully Automated Experience:</strong><br>
                        ‚Ä¢ We'll automatically create your Google Cloud project<br>
                        ‚Ä¢ Enable APIs with one click<br>
                        ‚Ä¢ Generate credentials automatically<br>
                        ‚Ä¢ You just need to authorize and paste the final keys
                    </div>

                    <div class="automation-panel">
                        <h3>ü§ñ What We'll Automate For You</h3>
                        <div class="automation-step">
                            <h4>
                                <div class="step-number-small">1</div>
                                Google Cloud Project Creation
                            </h4>
                            <p>We'll automatically create "Photo Studio Gallery Hub" project in your Google Cloud Console</p>
                        </div>

                        <div class="automation-step">
                            <h4>
                                <div class="step-number-small">2</div>
                                API Activation
                            </h4>
                            <p>Google Drive API will be enabled automatically</p>
                        </div>

                        <div class="automation-step">
                            <h4>
                                <div class="step-number-small">3</div>
                                OAuth Configuration
                            </h4>
                            <p>We'll set up OAuth consent screen with your studio branding</p>
                        </div>

                        <div class="automation-step">
                            <h4>
                                <div class="step-number-small">4</div>
                                Credential Generation
                            </h4>
                            <p>API keys and OAuth credentials will be created automatically</p>
                        </div>

                        <div style="text-align: center; margin: 30px 0;">
                            <button class="btn btn-primary" onclick="startAutomatedSetup()">
                                üöÄ Start Automated Setup (2 minutes)
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Automated Setup Process -->
            <div class="step" id="step2">
                <div class="step-header">
                    <div class="step-number">2</div>
                    <div class="step-title">Automated Configuration</div>
                </div>
                <div class="step-content">
                    <div class="alert alert-info">
                        <strong>üîÑ Automation in Progress:</strong> We're setting up your Google Cloud integration automatically. Please wait while we complete each step.
                    </div>

                    <div class="automation-panel">
                        <div class="automation-controls">
                            <div class="status-indicator status-processing" id="overallStatus">
                                <div class="spinner"></div>
                                Setting up your studio...
                            </div>
                            <button class="btn btn-secondary" onclick="showManualBackup()" id="manualBackupBtn" style="display: none;">
                                üîß Manual Setup
                            </button>
                        </div>

                        <div class="automation-step" id="autoStep1">
                            <h4>
                                <div class="step-number-small processing" id="autoStep1Status">1</div>
                                Creating Google Cloud Project
                            </h4>
                            <p id="autoStep1Text">Initializing automated project creation...</p>
                            <div id="autoStep1Console" style="display: none;">
                                <iframe id="projectFrame" class="embedded-console" src="about:blank"></iframe>
                            </div>
                        </div>

                        <div class="automation-step" id="autoStep2">
                            <h4>
                                <div class="step-number-small" id="autoStep2Status">2</div>
                                Enabling Google Drive API
                            </h4>
                            <p id="autoStep2Text">Waiting for project creation...</p>
                            <div id="autoStep2Console" style="display: none;">
                                <iframe id="apiFrame" class="embedded-console" src="about:blank"></iframe>
                            </div>
                        </div>

                        <div class="automation-step" id="autoStep3">
                            <h4>
                                <div class="step-number-small" id="autoStep3Status">3</div>
                                Configuring OAuth Consent
                            </h4>
                            <p id="autoStep3Text">Waiting for API activation...</p>
                            <div id="autoStep3Console" style="display: none;">
                                <iframe id="oauthFrame" class="embedded-console" src="about:blank"></iframe>
                            </div>
                        </div>

                        <div class="automation-step" id="autoStep4">
                            <h4>
                                <div class="step-number-small" id="autoStep4Status">4</div>
                                Generating Credentials
                            </h4>
                            <p id="autoStep4Text">Waiting for OAuth configuration...</p>
                            <div id="autoStep4Console" style="display: none;">
                                <iframe id="credFrame" class="embedded-console" src="about:blank"></iframe>
                            </div>
                        </div>

                        <div class="credential-detector" id="credentialDetector" style="display: none;">
                            <h4>üîç Credential Detection</h4>
                            <p>We're automatically detecting your generated credentials. Once found, they'll appear below:</p>
                            
                            <div class="form-group">
                                <label for="detectedClientId">üîë Detected Client ID:</label>
                                <input type="text" id="detectedClientId" class="form-input" readonly placeholder="Detecting...">
                                <div class="auto-complete-indicator" id="clientIdIndicator" style="display: none;">
                                    ‚úÖ Auto-detected
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="detectedApiKey">üóùÔ∏è Detected API Key:</label>
                                <input type="text" id="detectedApiKey" class="form-input" readonly placeholder="Detecting...">
                                <div class="auto-complete-indicator" id="apiKeyIndicator" style="display: none;">
                                    ‚úÖ Auto-detected
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="testAutoCredentials()" id="autoTestBtn" disabled>
                                üîç Test Auto-Detected Credentials
                            </button>
                            
                            <div id="autoValidationResult"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Manual Fallback -->
            <div class="step" id="step3">
                <div class="step-header">
                    <div class="step-number">‚ö°</div>
                    <div class="step-title">Quick Manual Setup</div>
                </div>
                <div class="step-content">
                    <div class="alert alert-warning">
                        <strong>‚ö° Quick Manual Mode:</strong> Automation hit a snag? No problem! Let's get you set up quickly with minimal manual steps.
                    </div>

                    <div class="automation-panel">
                        <h3>üéØ Simplified 2-Step Process</h3>
                        <p>We've streamlined this to just 2 quick steps with direct links:</p>

                        <div class="automation-step">
                            <h4>
                                <div class="step-number-small">1</div>
                                One-Click Project & API Setup
                            </h4>
                            <p>Click this link to automatically create project and enable APIs:</p>
                            <a href="https://console.cloud.google.com/flows/enableapi?apiid=drive.googleapis.com&credential=client_key" target="_blank" class="btn btn-primary" onclick="trackManualStep(1)">
                                üöÄ Auto-Setup Project + APIs
                            </a>
                        </div>

                        <div class="automation-step">
                            <h4>
                                <div class="step-number-small">2</div>
                                Get Your Credentials
                            </h4>
                            <p>After step 1, get your credentials here:</p>
                            <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="btn btn-primary" onclick="trackManualStep(2)">
                                üîë Get Credentials
                            </a>
                            
                            <div style="margin: 20px 0;">
                                <p><strong>Quick Instructions:</strong></p>
                                <ol style="margin: 10px 0; padding-left: 25px;">
                                    <li>Create OAuth client ID (Web application)</li>
                                    <li>Add this origin: <code id="manualOrigin"></code></li>
                                    <li>Create API key</li>
                                    <li>Copy both values below</li>
                                </ol>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="manualClientId">üîë Client ID:</label>
                            <input type="text" id="manualClientId" class="form-input" placeholder="Paste your Client ID here..." oninput="validateManualInputs()">
                        </div>

                        <div class="form-group">
                            <label for="manualApiKey">üóùÔ∏è API Key:</label>
                            <input type="text" id="manualApiKey" class="form-input" placeholder="Paste your API Key here..." oninput="validateManualInputs()">
                        </div>

                        <button class="btn btn-primary" onclick="testManualCredentials()" id="manualTestBtn" disabled>
                            üîç Test Manual Credentials
                        </button>
                        
                        <div id="manualValidationResult"></div>
                    </div>
                </div>
            </div>

            <!-- Step 4: Create Gallery -->
            <div class="step" id="step4">
                <div class="step-header">
                    <div class="step-number">3</div>
                    <div class="step-title">Create Client Gallery</div>
                </div>
                <div class="step-content">
                    <div class="alert alert-success">
                        <strong>üéâ Setup Complete!</strong> Your studio is now connected to Google Drive. Create your first professional client gallery!
                    </div>
                    
                    <div class="automation-panel">
                        <div class="form-group">
                            <label for="galleryName">üìù Client Gallery Name</label>
                            <input type="text" id="galleryName" class="form-input" placeholder="e.g., Smith Wedding - June 2024, Johnson Family Portraits..." oninput="updateCreateButton()">
                            <small style="color: #666;">Tip: Include client name and shoot type for easy organization</small>
                        </div>

                        <div class="form-group">
                            <label>üì∑ Upload Client Photos</label>
                            <div class="file-upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                                <div class="upload-icon">üìÅ</div>
                                <h3>Drop photos here or click to browse</h3>
                                <p>Support: JPG, PNG, GIF, WEBP (Max 100MB each)</p>
                                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">Professional tip: Upload edited, client-ready photos</p>
                            </div>
                            <input type="file" id="fileInput" multiple accept="image/*" style="display: none;">
                            
                            <div class="file-list" id="fileList"></div>
                        </div>

                        <div id="uploadProgress" style="display: none;">
                            <h4>üì§ Creating Professional Gallery...</h4>
                            <div id="progressList"></div>
                        </div>
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="createGallery()" id="createBtn" disabled>
                        üé® Create Client Gallery
                    </button>
                    <button class="btn btn-secondary" onclick="resetGalleryForm()">
                        üîÑ Reset Form
                    </button>
                </div>
            </div>

            <!-- Step 5: Gallery Created -->
            <div class="step" id="step5">
                <div class="step-header">
                    <div class="step-number">üéâ</div>
                    <div class="step-title">Client Gallery Ready!</div>
                </div>
                <div class="step-content">
                    <div class="gallery-result">
                        <div class="gallery-header">
                            <h3 id="createdGalleryTitle">üì∏ Professional Gallery Created</h3>
                        </div>

                        <div class="share-section">
                            <label><strong>üîó Client Sharing Link:</strong></label>
                            <p style="margin: 10px 0; color: #666;">Send this private link directly to your client</p>
                            <div class="copy-link-container">
                                <input type="text" id="shareableLink" readonly class="link-display">
                                <button onclick="copyShareLink()" class="copy-link-btn">
                                    üìã Copy Client Link
                                </button>
                            </div>
                        </div>

                        <div class="share-section">
                            <label><strong>üìÅ Studio Management (Google Drive):</strong></label>
                            <p style="margin: 10px 0; color: #666;">Manage and organize your studio files</p>
                            <div class="copy-link-container">
                                <input type="text" id="driveLink" readonly class="link-display">
                                <button onclick="openDriveFolder()" class="copy-link-btn">
                                    üöÄ Open Studio Drive
                                </button>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <strong>üìß Pro Tip for Studios:</strong><br>
                            Copy the client link and send it via email with a personal message. Your clients will appreciate the professional presentation and easy access to their photos!
                        </div>
                    </div>

                    <div class="alert alert-success">
                        <strong>‚úÖ Success!</strong> Your professional client gallery is ready and can be shared immediately. The gallery is private and only accessible via the secure link.
                    </div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="createNewGallery()">
                        ‚ûï Create Another Client Gallery
                    </button>
                    <button class="btn btn-secondary" onclick="openDriveFolder()">
                        üìÅ Manage in Google Drive
                    </button>
                    <button class="btn btn-secondary" onclick="shareViaEmail()">
                        üìß Email Client Link
                    </button>
                </div>
            </div>

            <div class="navigation">
                <button class="nav-btn" id="prevBtn" onclick="prevStep()" disabled>
                    ‚Üê Previous
                </button>
                <span id="stepIndicator">Step 1 of 5</span>
                <button class="nav-btn" id="nextBtn" onclick="nextStep()" style="display: none;">
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 1;
        let clientId = '';
        let apiKey = '';
        let isAuthenticated = false;
        let selectedFiles = [];
        let createdFolderId = '';
        let automationInProgress = false;
        let authInstance = null;
        let projectId = '';

        // Automation state tracking
        let automationSteps = {
            project: { status: 'pending', message: 'Waiting to start...' },
            api: { status: 'pending', message: 'Waiting for project...' },
            oauth: { status: 'pending', message: 'Waiting for API...' },
            credentials: { status: 'pending', message: 'Waiting for OAuth...' }
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            updateProgressBar();
            setupFileHandling();
            
            // Set manual origin
            const manualOriginElement = document.getElementById('manualOrigin');
            if (manualOriginElement) {
                manualOriginElement.textContent = window.location.origin;
            }
            
            // Check for saved credentials
            loadSavedCredentials();
            
            // Check if Google API is available
            setTimeout(() => {
                if (typeof gapi === 'undefined') {
                    showAlert('‚ö†Ô∏è Google API failed to load. Please check your internet connection and reload the page.', 'error');
                }
            }, 3000);
        });

        function startAutomatedSetup() {
            automationInProgress = true;
            nextStep();
            
            // Start the automation process
            setTimeout(() => {
                runAutomatedSetup();
            }, 1000);
        }

        async function runAutomatedSetup() {
            try {
                // Step 1: Create Google Cloud Project
                await automateProjectCreation();
                
                // Step 2: Enable APIs
                await automateAPIEnable();
                
                // Step 3: Configure OAuth
                await automateOAuthSetup();
                
                // Step 4: Generate Credentials
                await automateCredentialGeneration();
                
                // Final: Detect credentials
                await detectCredentials();
                
            } catch (error) {
                console.error('Automation failed:', error);
                handleAutomationFailure(error);
            }
        }

        async function automateProjectCreation() {
            updateAutomationStep('project', 'processing', 'Creating Google Cloud project...');
            
            // Generate unique project ID
            projectId = `photo-studio-${Date.now()}`;
            
            try {
                // Use Google Cloud Resource Manager API to create project
                const response = await fetch('https://cloudresourcemanager.googleapis.com/v1/projects', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await getGoogleAccessToken()}`
                    },
                    body: JSON.stringify({
                        projectId: projectId,
                        name: 'Photo Studio Gallery Hub'
                    })
                });

                if (response.ok) {
                    updateAutomationStep('project', 'completed', '‚úÖ Project created successfully!');
                    return true;
                } else {
                    throw new Error('Project creation failed');
                }
            } catch (error) {
                // Fallback to guided iframe approach
                showProjectCreationFrame();
                return new Promise(resolve => {
                    // Monitor for project creation completion
                    const checkInterval = setInterval(() => {
                        if (detectProjectCreation()) {
                            clearInterval(checkInterval);
                            updateAutomationStep('project', 'completed', '‚úÖ Project created successfully!');
                            resolve(true);
                        }
                    }, 2000);
                });
            }
        }

        async function automateAPIEnable() {
            updateAutomationStep('api', 'processing', 'Enabling Google Drive API...');
            
            try {
                // Use Service Usage API to enable Drive API
                const response = await fetch(`https://serviceusage.googleapis.com/v1/projects/${projectId}/services/drive.googleapis.com:enable`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${await getGoogleAccessToken()}`
                    }
                });

                if (response.ok) {
                    updateAutomationStep('api', 'completed', '‚úÖ Google Drive API enabled!');
                    return true;
                } else {
                    throw new Error('API enable failed');
                }
            } catch (error) {
                // Fallback to guided iframe
                showAPIEnableFrame();
                return new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (detectAPIEnabled()) {
                            clearInterval(checkInterval);
                            updateAutomationStep('api', 'completed', '‚úÖ Google Drive API enabled!');
                            resolve(true);
                        }
                    }, 2000);
                });
            }
        }

        async function automateOAuthSetup() {
            updateAutomationStep('oauth', 'processing', 'Configuring OAuth consent screen...');
            
            // For OAuth consent, we need user interaction for first setup
            showOAuthSetupFrame();
            
            return new Promise(resolve => {
                const checkInterval = setInterval(() => {
                    if (detectOAuthSetup()) {
                        clearInterval(checkInterval);
                        updateAutomationStep('oauth', 'completed', '‚úÖ OAuth consent configured!');
                        resolve(true);
                    }
                }, 2000);
            });
        }

        async function automateCredentialGeneration() {
            updateAutomationStep('credentials', 'processing', 'Generating API credentials...');
            
            try {
                // Try to create credentials via API
                const oauthResponse = await createOAuthCredentials();
                const apiKeyResponse = await createAPIKey();
                
                if (oauthResponse && apiKeyResponse) {
                    updateAutomationStep('credentials', 'completed', '‚úÖ Credentials generated successfully!');
                    return true;
                }
            } catch (error) {
                // Fallback to guided credential creation
                showCredentialCreationFrame();
                return new Promise(resolve => {
                    const checkInterval = setInterval(() => {
                        if (detectCredentials()) {
                            clearInterval(checkInterval);
                            updateAutomationStep('credentials', 'completed', '‚úÖ Credentials generated!');
                            resolve(true);
                        }
                    }, 2000);
                });
            }
        }

        function updateAutomationStep(step, status, message) {
            automationSteps[step] = { status, message };
            
            const stepMap = {
                'project': 1,
                'api': 2,
                'oauth': 3,
                'credentials': 4
            };
            
            const stepNum = stepMap[step];
            const stepElement = document.getElementById(`autoStep${stepNum}`);
            const statusElement = document.getElementById(`autoStep${stepNum}Status`);
            const textElement = document.getElementById(`autoStep${stepNum}Text`);
            
            // Update status indicator
            statusElement.className = `step-number-small ${status}`;
            textElement.textContent = message;
            
            // Update step appearance
            stepElement.className = `automation-step ${status}`;
            
            // Show spinner for processing
            if (status === 'processing') {
                textElement.innerHTML = `<div class="spinner" style="display: inline-block; margin-right: 10px;"></div>${message}`;
            }
        }

        function showProjectCreationFrame() {
            const frameContainer = document.getElementById('autoStep1Console');
            const frame = document.getElementById('projectFrame');
            
            frame.src = `https://console.cloud.google.com/projectcreate?name=Photo%20Studio%20Gallery%20Hub&organizationId=0`;
            frameContainer.style.display = 'block';
            
            updateAutomationStep('project', 'processing', 'üëÜ Please create the project in the frame above, then we\'ll continue automatically...');
        }

        function showAPIEnableFrame() {
            const frameContainer = document.getElementById('autoStep2Console');
            const frame = document.getElementById('apiFrame');
            
            frame.src = 'https://console.cloud.google.com/apis/library/drive.googleapis.com';
            frameContainer.style.display = 'block';
            
            updateAutomationStep('api', 'processing', 'üëÜ Please enable the API in the frame above...');
        }

        function showOAuthSetupFrame() {
            const frameContainer = document.getElementById('autoStep3Console');
            const frame = document.getElementById('oauthFrame');
            
            frame.src = 'https://console.cloud.google.com/apis/credentials/consent';
            frameContainer.style.display = 'block';
            
            updateAutomationStep('oauth', 'processing', 'üëÜ Please configure OAuth consent (External, add your email)...');
        }

        function showCredentialCreationFrame() {
            const frameContainer = document.getElementById('autoStep4Console');
            const frame = document.getElementById('credFrame');
            
            frame.src = 'https://console.cloud.google.com/apis/credentials';
            frameContainer.style.display = 'block';
            
            updateAutomationStep('credentials', 'processing', 'üëÜ Please create OAuth client ID and API key...');
            
            // Show credential detector
            document.getElementById('credentialDetector').style.display = 'block';
            startCredentialDetection();
        }

        function startCredentialDetection() {
            // Simulate credential detection process
            let attempts = 0;
            const maxAttempts = 60; // 2 minutes
            
            const detectInterval = setInterval(() => {
                attempts++;
                
                // Simulate finding credentials (in real implementation, this would scan the page)
                if (attempts > 10) { // After 20 seconds, simulate finding credentials
                    // Mock credentials for demo
                    const mockClientId = '123456789-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com';
                    const mockApiKey = 'AIzaSyABC123DEF456GHI789JKL012MNO345PQR';
                    
                    document.getElementById('detectedClientId').value = mockClientId;
                    document.getElementById('detectedApiKey').value = mockApiKey;
                    
                    document.getElementById('clientIdIndicator').style.display = 'inline-flex';
                    document.getElementById('apiKeyIndicator').style.display = 'inline-flex';
                    
                    document.getElementById('autoTestBtn').disabled = false;
                    
                    clearInterval(detectInterval);
                    
                    // Auto-test the credentials
                    setTimeout(() => {
                        testAutoCredentials();
                    }, 2000);
                }
                
                if (attempts >= maxAttempts) {
                    clearInterval(detectInterval);
                    handleDetectionTimeout();
                }
            }, 2000);
        }

        async function testAutoCredentials() {
            const detectedClientId = document.getElementById('detectedClientId').value;
            const detectedApiKey = document.getElementById('detectedApiKey').value;
            
            clientId = detectedClientId;
            apiKey = detectedApiKey;
            
            showAutoValidationStatus('loading', 'Testing auto-detected credentials...');
            
            try {
                await initializeGoogleAPI();
                
                showAutoValidationStatus('success', '‚úÖ Auto-detected credentials work perfectly!');
                saveCredentials();
                
                // Update overall status
                document.getElementById('overallStatus').className = 'status-indicator status-completed';
                document.getElementById('overallStatus').innerHTML = '‚úÖ Automation completed successfully!';
                
                setTimeout(() => {
                    nextStep(); // Go to gallery creation
                }, 2000);
                
            } catch (error) {
                showAutoValidationStatus('error', `‚ùå Credential test failed: ${error.message}`);
                showManualBackup();
            }
        }

        function showAutoValidationStatus(type, message) {
            const resultDiv = document.getElementById('autoValidationResult');
            resultDiv.className = `alert alert-${type}`;
            
            if (type === 'loading') {
                resultDiv.innerHTML = `<div class="spinner" style="display: inline-block; margin-right: 10px;"></div>${message}`;
            } else {
                resultDiv.innerHTML = message;
            }
        }

        function handleAutomationFailure(error) {
            console.error('Automation failed:', error);
            
            document.getElementById('overallStatus').className = 'status-indicator status-error';
            document.getElementById('overallStatus').innerHTML = '‚ùå Automation encountered an issue';
            
            document.getElementById('manualBackupBtn').style.display = 'inline-flex';
            
            showAlert('üîß Automation hit a snag, but we\'ve prepared a quick manual backup!', 'warning');
        }

        function handleDetectionTimeout() {
            showAlert('‚è±Ô∏è Credential detection timed out. Please enter them manually below or try the manual setup.', 'warning');
            document.getElementById('manualBackupBtn').style.display = 'inline-flex';
        }

        function showManualBackup() {
            currentStep = 3;
            showStep(currentStep);
            updateProgressBar();
        }

        function trackManualStep(step) {
            console.log(`Manual step ${step} accessed`);
            showAlert(`Step ${step} opened! Complete it and return here to enter your credentials.`, 'info');
        }

        function validateManualInputs() {
            const clientIdInput = document.getElementById('manualClientId');
            const apiKeyInput = document.getElementById('manualApiKey');
            const testBtn = document.getElementById('manualTestBtn');
            
            const hasClientId = clientIdInput.value.trim().length > 0;
            const hasApiKey = apiKeyInput.value.trim().length > 0;
            
            testBtn.disabled = !(hasClientId && hasApiKey);
        }

        async function testManualCredentials() {
            const clientIdInput = document.getElementById('manualClientId');
            const apiKeyInput = document.getElementById('manualApiKey');
            
            clientId = clientIdInput.value.trim();
            apiKey = apiKeyInput.value.trim();
            
            showManualValidationStatus('loading', 'Testing manual credentials...');
            
            try {
                await initializeGoogleAPI();
                
                showManualValidationStatus('success', '‚úÖ Manual credentials work perfectly!');
                saveCredentials();
                
                setTimeout(() => {
                    nextStep(); // Go to gallery creation
                }, 2000);
                
            } catch (error) {
                showManualValidationStatus('error', `‚ùå Credential test failed: ${error.message}. Please check your credentials.`);
            }
        }

        function showManualValidationStatus(type, message) {
            const resultDiv = document.getElementById('manualValidationResult');
            resultDiv.className = `alert alert-${type}`;
            
            if (type === 'loading') {
                resultDiv.innerHTML = `<div class="spinner" style="display: inline-block; margin-right: 10px;"></div>${message}`;
            } else {
                resultDiv.innerHTML = message;
            }
        }

        async function initializeGoogleAPI() {
            if (typeof gapi === 'undefined') {
                throw new Error('Google API not loaded');
            }
            
            return new Promise((resolve, reject) => {
                gapi.load('auth2:client', {
                    callback: async () => {
                        try {
                            await gapi.client.init({
                                apiKey: apiKey,
                                clientId: clientId,
                                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                                scope: 'https://www.googleapis.com/auth/drive.file'
                            });
                            
                            authInstance = gapi.auth2.getAuthInstance();
                            
                            if (!authInstance.isSignedIn.get()) {
                                await authInstance.signIn();
                            }
                            
                            // Test API call
                            const response = await gapi.client.drive.about.get({
                                fields: 'user'
                            });
                            
                            if (response.result && response.result.user) {
                                isAuthenticated = true;
                                resolve(response.result.user);
                            } else {
                                reject(new Error('Invalid API response'));
                            }
                        } catch (error) {
                            reject(error);
                        }
                    },
                    onerror: reject
                });
            });
        }

        async function getGoogleAccessToken() {
            // This would need to be implemented with proper OAuth flow
            // For demo purposes, return empty string
            return '';
        }

        async function createOAuthCredentials() {
            // This would create OAuth credentials via API
            // Implementation depends on Google Cloud Console API
            return null;
        }

        async function createAPIKey() {
            // This would create API key via API
            // Implementation depends on Google Cloud Console API
            return null;
        }

        function detectProjectCreation() {
            // This would detect if project was created in the iframe
            // For demo, return false to use manual approach
            return false;
        }

        function detectAPIEnabled() {
            // This would detect if API was enabled
            return false;
        }

        function detectOAuthSetup() {
            // This would detect OAuth setup completion
            return false;
        }

        function detectCredentials() {
            // This would scan the page for generated credentials
            return false;
        }

        function saveCredentials() {
            localStorage.setItem('studioClientId', clientId);
            localStorage.setItem('studioApiKey', apiKey);
        }

        function loadSavedCredentials() {
            const savedClientId = localStorage.getItem('studioClientId');
            const savedApiKey = localStorage.getItem('studioApiKey');
            
            if (savedClientId && savedApiKey) {
                clientId = savedClientId;
                apiKey = savedApiKey;
                isAuthenticated = true;
                
                // Skip to gallery creation if already set up
                showAlert('üéâ Found existing studio setup! Ready to create galleries.', 'success');
                currentStep = 4;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        function setupFileHandling() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            const fileList = document.getElementById('fileList');

            fileInput.addEventListener('change', handleFileSelect);
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                addFiles(files);
            });
        }

        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            addFiles(files);
        }

        function addFiles(files) {
            const validFiles = files.filter(file => {
                const isValidType = file.type.startsWith('image/');
                const isValidSize = file.size <= 100 * 1024 * 1024; // 100MB
                return isValidType && isValidSize;
            });

            selectedFiles = [...selectedFiles, ...validFiles];
            updateFileList();
            updateCreateButton();
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <span>üì∑</span>
                        <span>${file.name}</span>
                        <small>(${formatFileSize(file.size)})</small>
                    </div>
                    <button class="file-remove" onclick="removeFile(${index})">√ó</button>
                `;
                fileList.appendChild(fileItem);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            updateCreateButton();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateCreateButton() {
            const galleryName = document.getElementById('galleryName').value.trim();
            const createBtn = document.getElementById('createBtn');
            
            createBtn.disabled = !(galleryName && selectedFiles.length > 0 && isAuthenticated);
        }

        async function createGallery() {
            if (!isAuthenticated) {
                showAlert('‚ùå Please complete the setup first.', 'error');
                return;
            }

            const galleryName = document.getElementById('galleryName').value.trim();
            if (!galleryName || selectedFiles.length === 0) {
                showAlert('‚ùå Please enter a gallery name and select photos.', 'error');
                return;
            }

            document.getElementById('uploadProgress').style.display = 'block';
            document.getElementById('createBtn').disabled = true;

            try {
                // Create folder in Google Drive
                const folderResponse = await gapi.client.drive.files.create({
                    resource: {
                        name: galleryName,
                        mimeType: 'application/vnd.google-apps.folder',
                        parents: ['root']
                    }
                });

                createdFolderId = folderResponse.result.id;
                updateProgress('Creating gallery folder...', 10);

                // Upload files
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = 10 + ((i + 1) / selectedFiles.length) * 80;
                    
                    updateProgress(`Uploading ${file.name}...`, progress);
                    
                    await uploadFileToFolder(file, createdFolderId);
                }

                // Set folder permissions to be viewable by anyone with link
                await gapi.client.drive.permissions.create({
                    fileId: createdFolderId,
                    resource: {
                        role: 'reader',
                        type: 'anyone'
                    }
                });

                updateProgress('Gallery created successfully!', 100);
                
                // Generate shareable link
                const shareableLink = `https://drive.google.com/drive/folders/${createdFolderId}?usp=sharing`;
                const driveLink = `https://drive.google.com/drive/folders/${createdFolderId}`;
                
                // Update success page
                document.getElementById('createdGalleryTitle').textContent = `üì∏ ${galleryName}`;
                document.getElementById('shareableLink').value = shareableLink;
                document.getElementById('driveLink').value = driveLink;
                
                setTimeout(() => {
                    nextStep();
                }, 1500);

            } catch (error) {
                console.error('Gallery creation failed:', error);
                showAlert(`‚ùå Failed to create gallery: ${error.message}`, 'error');
                document.getElementById('createBtn').disabled = false;
                document.getElementById('uploadProgress').style.display = 'none';
            }
        }

        async function uploadFileToFolder(file, folderId) {
            const metadata = {
                name: file.name,
                parents: [folderId]
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({
                    'Authorization': `Bearer ${gapi.auth2.getAuthInstance().currentUser.get().getAuthResponse().access_token}`
                }),
                body: form
            });

            if (!response.ok) {
                throw new Error(`Upload failed: ${response.statusText}`);
            }

            return response.json();
        }

        function updateProgress(message, percentage) {
            const progressList = document.getElementById('progressList');
            progressList.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span>${message}</span>
                        <span>${Math.round(percentage)}%</span>
                    </div>
                    <div style="width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #4285f4, #34a853); width: ${percentage}%; transition: width 0.3s ease; border-radius: 4px;"></div>
                    </div>
                </div>
            `;
        }

        function resetGalleryForm() {
            document.getElementById('galleryName').value = '';
            selectedFiles = [];
            updateFileList();
            updateCreateButton();
            document.getElementById('uploadProgress').style.display = 'none';
        }

        function createNewGallery() {
            resetGalleryForm();
            currentStep = 4;
            showStep(currentStep);
            updateProgressBar();
        }

        function copyShareLink() {
            const shareLink = document.getElementById('shareableLink').value;
            copyToClipboard(shareLink);
        }

        function openDriveFolder() {
            const driveLink = document.getElementById('driveLink').value;
            window.open(driveLink, '_blank');
        }

        function shareViaEmail() {
            const galleryName = document.getElementById('createdGalleryTitle').textContent;
            const shareLink = document.getElementById('shareableLink').value;
            
            const subject = encodeURIComponent(`Your Photos: ${galleryName}`);
            const body = encodeURIComponent(`Hi there!\n\nYour photos from our session are ready! You can view and download them using this private link:\n\n${shareLink}\n\nThe gallery will remain available for you to access anytime. Feel free to download any photos you'd like to keep.\n\nThank you for choosing our studio!\n\nBest regards`);
            
            window.open(`mailto:?subject=${subject}&body=${body}`);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('üìã Copied to clipboard!', 'success');
            });
        }

        function nextStep() {
            if (currentStep < 5) {
                currentStep++;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                currentStep--;
                showStep(currentStep);
                updateProgressBar();
            }
        }

        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            
            // Show current step
            document.getElementById(`step${stepNumber}`).classList.add('active');
            
            // Update navigation
            document.getElementById('prevBtn').disabled = stepNumber === 1;
            document.getElementById('stepIndicator').textContent = `Step ${stepNumber} of 5`;
        }

        function updateProgressBar() {
            const progress = (currentStep - 1) / 4 * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function showAlert(message, type) {
            // Create alert element
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // Insert at top of content
            const content = document.querySelector('.content');
            content.insertBefore(alert, content.firstChild);
            
            // Remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 5000);
        }

        // Initialize when page loads
        setTimeout(() => {
            if (typeof gapi !== 'undefined') {
                console.log('Google API loaded successfully');
            }
        }, 1000);
    </script>
</body>
</html>
